<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KDS Demo - Kitchen Display System</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header {
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .header h1 {
      margin: 0;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .status.connected { background: #d4edda; color: #155724; }
    .status.disconnected { background: #f8d7da; color: #721c24; }
    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .input-group label {
      font-weight: bold;
      font-size: 14px;
    }
    input, select, button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      min-width: 80px;
    }
    button:hover { background: #0056b3; }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .events-container {
      border: 1px solid #ddd;
      border-radius: 4px;
      height: 400px;
      overflow-y: auto;
      padding: 10px;
      background: #fafafa;
    }
    .event-item {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 4px;
      border-left: 4px solid #007bff;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .event-item.heartbeat {
      border-left-color: #28a745;
      opacity: 0.7;
    }
    .event-item.line_update {
      border-left-color: #ffc107;
    }
    .event-timestamp {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .event-data {
      font-family: 'Courier New', monospace;
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      white-space: pre-wrap;
      font-size: 12px;
    }
    .clear-btn {
      background: #dc3545;
      float: right;
    }
    .clear-btn:hover { background: #c82333; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        ğŸ³ KDS Demo
        <span id="connectionStatus" class="status disconnected">ì—°ê²° ì•ˆë¨</span>
      </h1>
      <p>Kitchen Display System ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ëª¨ë‹ˆí„°ë§</p>
    </div>

    <div class="controls">
      <div class="input-group">
        <label>ë§¤ì¥ ID:</label>
        <input type="number" id="storeId" placeholder="1" value="1" min="1">
      </div>

      <div class="input-group">
        <label>ìŠ¤í…Œì´ì…˜ í•„í„°:</label>
        <input type="text" id="stationsFilter" placeholder="FRY,GRILL,DRINK" value="">
      </div>

      <button id="connectBtn" onclick="connectSSE()">ì—°ê²°</button>
      <button id="disconnectBtn" onclick="disconnectSSE()" disabled>ì—°ê²° í•´ì œ</button>
      <button class="clear-btn" onclick="clearEvents()">ì´ë²¤íŠ¸ ì§€ìš°ê¸°</button>
    </div>

    <div class="events-container" id="eventsContainer">
      <p style="text-align: center; color: #666; margin-top: 100px;">
        ë§¤ì¥ IDë¥¼ ì…ë ¥í•˜ê³  ì—°ê²° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”
      </p>
    </div>
  </div>

  <script>
    let eventSource = null;
    let eventCount = 0;

    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connectionStatus');
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');

      if (connected) {
        statusEl.textContent = 'ì—°ê²°ë¨';
        statusEl.className = 'status connected';
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
      } else {
        statusEl.textContent = 'ì—°ê²° ì•ˆë¨';
        statusEl.className = 'status disconnected';
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
      }
    }

    function connectSSE() {
      const storeId = document.getElementById('storeId').value;
      const stations = document.getElementById('stationsFilter').value;

      if (!storeId) {
        alert('ë§¤ì¥ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      disconnectSSE(); // ê¸°ì¡´ ì—°ê²° í•´ì œ

      let url = `/api/kds/stream`;
      if (stations) {
        url += `?stations=${encodeURIComponent(stations)}`;
      }

      // SSEì—ì„œ í—¤ë”ë¥¼ ì§ì ‘ ì„¤ì •í•˜ëŠ” ê²ƒì€ í‘œì¤€ APIì—ì„œ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      // ëŒ€ì‹ , URL ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜ ë˜ëŠ” ë‹¤ë¥¸ ë°©ë²•ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
      // ì—¬ê¸°ì„œëŠ” storeIdë¥¼ URLì— ì¶”ê°€í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì •í•©ë‹ˆë‹¤.
      url += (url.includes('?') ? '&' : '?') + `storeId=${storeId}`;

      eventSource = new EventSource(url);

      eventSource.onopen = function() {
        updateConnectionStatus(true);
        addEvent('ì—°ê²°', { type: 'connection', message: `ë§¤ì¥ ${storeId} KDS ìŠ¤íŠ¸ë¦¼ ì—°ê²°ë¨` });
      };

      eventSource.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          addEvent('ì´ë²¤íŠ¸', data);
        } catch (error) {
          addEvent('ì˜¤ë¥˜', { type: 'parse_error', data: event.data });
        }
      };

      eventSource.onerror = function(error) {
        console.error('SSE ì˜¤ë¥˜:', error);
        updateConnectionStatus(false);
        addEvent('ì˜¤ë¥˜', { type: 'connection_error', message: 'SSE ì—°ê²° ì˜¤ë¥˜' });
      };
    }

    function disconnectSSE() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
        updateConnectionStatus(false);
        addEvent('ì—°ê²°', { type: 'disconnection', message: 'SSE ì—°ê²° í•´ì œë¨' });
      }
    }

    function addEvent(type, data) {
      const container = document.getElementById('eventsContainer');
      const eventEl = document.createElement('div');

      eventCount++;

      const eventClass = data.type === 'heartbeat' ? 'event-item heartbeat' : 
                        data.type === 'line_update' ? 'event-item line_update' : 'event-item';

      eventEl.className = eventClass;
      eventEl.innerHTML = `
        <div class="event-timestamp">
          #${eventCount} - ${new Date().toLocaleTimeString('ko-KR')} [${type}]
        </div>
        <div class="event-data">${JSON.stringify(data, null, 2)}</div>
      `;

      container.appendChild(eventEl);
      container.scrollTop = container.scrollHeight;

      // í•˜íŠ¸ë¹„íŠ¸ ì´ë²¤íŠ¸ëŠ” 5ì´ˆ í›„ ìë™ ì‚­ì œ
      if (data.type === 'heartbeat') {
        setTimeout(() => {
          if (eventEl.parentNode) {
            eventEl.remove();
          }
        }, 5000);
      }
    }

    function clearEvents() {
      const container = document.getElementById('eventsContainer');
      container.innerHTML = '<p style="text-align: center; color: #666; margin-top: 100px;">ì´ë²¤íŠ¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤</p>';
      eventCount = 0;
    }

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° í•´ì œ
    window.addEventListener('beforeunload', disconnectSSE);
  </script>
</body>
</html>