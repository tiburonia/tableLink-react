
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDS Demo - TableLink</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .kds-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 10px;
        }

        .kds-title {
            font-size: 24px;
            font-weight: bold;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
        }

        .status-indicator.connected {
            background: #44ff44;
        }

        .kds-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .kds-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .kds-btn:hover {
            background: #0056b3;
        }

        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .order-card {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #666;
        }

        .order-card.queued {
            border-left-color: #ffc107;
        }

        .order-card.cooking {
            border-left-color: #ff6b35;
        }

        .order-card.ready {
            border-left-color: #28a745;
        }

        .order-card.served {
            border-left-color: #6c757d;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .order-info {
            font-size: 14px;
            color: #ccc;
        }

        .order-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-queued {
            background: #ffc107;
            color: #000;
        }

        .status-cooking {
            background: #ff6b35;
            color: #fff;
        }

        .status-ready {
            background: #28a745;
            color: #fff;
        }

        .status-served {
            background: #6c757d;
            color: #fff;
        }

        .order-items {
            margin: 15px 0;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #444;
        }

        .order-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .start-btn {
            background: #ff6b35;
            color: white;
        }

        .complete-btn {
            background: #28a745;
            color: white;
        }

        .serve-btn {
            background: #007bff;
            color: white;
        }

        .log-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            font-size: 12px;
            z-index: 1000;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 5px;
            background: #2a2a2a;
            border-radius: 3px;
        }

        .log-time {
            color: #888;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div class="kds-header">
        <div class="kds-title">üç≥ Kitchen Display System</div>
        <div class="connection-status">
            <div class="status-indicator" id="connectionStatus"></div>
            <span id="connectionText">Ïó∞Í≤∞ Ï§ë...</span>
        </div>
    </div>

    <div class="kds-controls">
        <button class="kds-btn" onclick="connectSSE()">SSE Ïó∞Í≤∞</button>
        <button class="kds-btn" onclick="refreshOrders()">Ï£ºÎ¨∏ ÏÉàÎ°úÍ≥†Ïπ®</button>
        <button class="kds-btn" onclick="toggleLog()">Î°úÍ∑∏ ÌÜ†Í∏Ä</button>
        <input type="number" id="storeIdInput" placeholder="Îß§Ïû• ID" value="1" style="padding: 10px; border-radius: 5px; border: 1px solid #444; background: #333; color: white;">
    </div>

    <div class="orders-grid" id="ordersGrid">
        <!-- Ï£ºÎ¨∏ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
    </div>

    <div class="log-panel" id="logPanel" style="display: none;">
        <h4>Ïù¥Î≤§Ìä∏ Î°úÍ∑∏</h4>
        <div id="logContent"></div>
    </div>

    <script>
        let eventSource = null;
        let orders = new Map();
        let storeId = 1;

        function log(message) {
            const logContent = document.getElementById('logContent');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <div class="log-time">${new Date().toLocaleTimeString()}</div>
                <div>${message}</div>
            `;
            logContent.insertBefore(entry, logContent.firstChild);
            
            // ÏµúÎåÄ 50Í∞ú Î°úÍ∑∏Îßå Ïú†ÏßÄ
            while (logContent.children.length > 50) {
                logContent.removeChild(logContent.lastChild);
            }
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'Ïó∞Í≤∞Îê®';
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'Ïó∞Í≤∞ ÎÅäÍπÄ';
            }
        }

        function connectSSE() {
            storeId = document.getElementById('storeIdInput').value || 1;
            
            if (eventSource) {
                eventSource.close();
            }

            log(`SSE Ïó∞Í≤∞ ÏãúÎèÑ: Îß§Ïû• ${storeId}`);
            
            eventSource = new EventSource(`/api/kds/stream?stations=FRY,GRILL`, {
                headers: {
                    'X-Store-Id': storeId
                }
            });

            eventSource.onopen = () => {
                log('SSE Ïó∞Í≤∞ ÏÑ±Í≥µ');
                updateConnectionStatus(true);
            };

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    log(`ÏàòÏã†: ${data.type} - ${JSON.stringify(data).substring(0, 100)}...`);
                    
                    if (data.type === 'line_update') {
                        // Ïã§ÏãúÍ∞Ñ ÎùºÏù∏ ÏóÖÎç∞Ïù¥Ìä∏ Ï≤òÎ¶¨
                        refreshOrders();
                    }
                } catch (error) {
                    log(`Î©îÏãúÏßÄ ÌååÏã± Ïò§Î•ò: ${error.message}`);
                }
            };

            eventSource.onerror = (error) => {
                log('SSE Ïó∞Í≤∞ Ïò§Î•ò');
                updateConnectionStatus(false);
            };
        }

        async function refreshOrders() {
            try {
                const response = await fetch(`/api/kds/poll?status=queued,cooking,ready`, {
                    headers: {
                        'X-Store-Id': storeId
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú: ${data.lines.length}Í±¥`);
                    renderOrders(data.lines);
                } else {
                    log(`Ï£ºÎ¨∏ Î°úÎìú Ïã§Ìå®: ${data.error}`);
                }
            } catch (error) {
                log(`Ï£ºÎ¨∏ Î°úÎìú Ïò§Î•ò: ${error.message}`);
            }
        }

        function renderOrders(lines) {
            const grid = document.getElementById('ordersGrid');
            
            // ÎùºÏù∏ÏùÑ Ï£ºÎ¨∏Î≥ÑÎ°ú Í∑∏Î£πÌôî
            const orderGroups = new Map();
            
            lines.forEach(line => {
                const key = `${line.order_id}-${line.table_number}`;
                if (!orderGroups.has(key)) {
                    orderGroups.set(key, {
                        orderId: line.order_id,
                        tableNumber: line.table_number,
                        customerName: line.customer_name || 'ÏÜêÎãò',
                        source: line.source,
                        lines: []
                    });
                }
                orderGroups.get(key).lines.push(line);
            });

            grid.innerHTML = '';
            
            orderGroups.forEach((order, key) => {
                const card = document.createElement('div');
                card.className = `order-card ${getOrderStatus(order.lines)}`;
                card.innerHTML = `
                    <div class="order-header">
                        <div class="order-info">
                            <div>Ï£ºÎ¨∏ #${order.orderId}</div>
                            <div>ÌÖåÏù¥Î∏î ${order.tableNumber}</div>
                            <div>${order.customerName}</div>
                        </div>
                        <div class="order-status status-${getOrderStatus(order.lines)}">
                            ${getStatusText(getOrderStatus(order.lines))}
                        </div>
                    </div>
                    
                    <div class="order-items">
                        ${order.lines.map(line => `
                            <div class="order-item">
                                <span>${line.menu_name} x${line.quantity}</span>
                                <span class="status-${line.status}">${getStatusText(line.status)}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="order-actions">
                        ${renderOrderActions(order.lines)}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function getOrderStatus(lines) {
            if (lines.every(l => l.status === 'served')) return 'served';
            if (lines.some(l => l.status === 'ready')) return 'ready';
            if (lines.some(l => l.status === 'cooking')) return 'cooking';
            return 'queued';
        }

        function getStatusText(status) {
            const statusMap = {
                'queued': 'ÎåÄÍ∏∞Ï§ë',
                'cooking': 'Ï°∞Î¶¨Ï§ë',
                'ready': 'ÏôÑÎ£å',
                'served': 'ÏÑúÎπôÏôÑÎ£å'
            };
            return statusMap[status] || status;
        }

        function renderOrderActions(lines) {
            const queuedLines = lines.filter(l => l.status === 'queued');
            const cookingLines = lines.filter(l => l.status === 'cooking');
            const readyLines = lines.filter(l => l.status === 'ready');

            let actions = '';

            if (queuedLines.length > 0) {
                actions += `<button class="action-btn start-btn" onclick="updateLineStatus(${queuedLines[0].line_id}, 'cooking')">üî• Ï°∞Î¶¨ ÏãúÏûë</button>`;
            }

            if (cookingLines.length > 0) {
                actions += `<button class="action-btn complete-btn" onclick="updateLineStatus(${cookingLines[0].line_id}, 'ready')">‚úÖ Ï°∞Î¶¨ ÏôÑÎ£å</button>`;
            }

            if (readyLines.length > 0) {
                actions += `<button class="action-btn serve-btn" onclick="updateLineStatus(${readyLines[0].line_id}, 'served')">üçΩÔ∏è ÏÑúÎπô ÏôÑÎ£å</button>`;
            }

            return actions;
        }

        async function updateLineStatus(lineId, status) {
            try {
                log(`ÎùºÏù∏ ${lineId} ÏÉÅÌÉú Î≥ÄÍ≤Ω: ${status}`);
                
                const response = await fetch(`/api/kds/lines/${lineId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Store-Id': storeId
                    },
                    body: JSON.stringify({ status })
                });

                const data = await response.json();
                
                if (data.success) {
                    log(`ÎùºÏù∏ ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏÑ±Í≥µ: ${lineId} ‚Üí ${status}`);
                    refreshOrders();
                } else {
                    log(`ÎùºÏù∏ ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®: ${data.error}`);
                }
            } catch (error) {
                log(`ÎùºÏù∏ ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïò§Î•ò: ${error.message}`);
            }
        }

        function toggleLog() {
            const panel = document.getElementById('logPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            log('KDS Îç∞Î™® ÏãúÏûë');
            refreshOrders();
        });
    </script>
</body>
</html>
