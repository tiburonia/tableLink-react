<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS ë°ëª¨</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .step-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      transition: all 0.3s;
    }

    .step-1 { background: #4CAF50; }
    .step-2 { background: #2196F3; }
    .step-3 { background: #FF9800; }
    .step-4 { background: #9C27B0; }
    .step-5 { background: #607D8B; }
    .step-6 { background: #795548; }

    .step-btn:hover { opacity: 0.8; }
    .step-btn:disabled { opacity: 0.3; cursor: not-allowed; }

    .response-container {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      min-height: 400px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-y: auto;
    }

    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .info { color: #2196F3; }

    .inputs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }

    input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸª POS ì‹œìŠ¤í…œ ë°ëª¨</h1>

    <div class="inputs">
      <label>ë§¤ì¥ ID:</label>
      <input type="number" id="storeId" value="1">

      <label>í…Œì´ë¸” ë²ˆí˜¸:</label>
      <input type="number" id="tableNumber" value="3">

      <label>ì‚¬ìš©ì ID:</label>
      <input type="text" id="userId" value="u1" placeholder="ì„ íƒì‚¬í•­">
    </div>

    <div class="controls">
      <button class="step-btn step-1" onclick="createCheck()">
        1. ì²´í¬ ìƒì„± (TLL QR)
      </button>

      <button class="step-btn step-2" onclick="createOrder()">
        2. ì£¼ë¬¸ ìƒì„±
      </button>

      <button class="step-btn step-3" onclick="addOrderLines()">
        3. í›„ë¼ì´ë“œ 2ê°œ ì¶”ê°€
      </button>

      <button class="step-btn step-4" onclick="cancelOneLine()">
        4. 1ê°œ ì·¨ì†Œ
      </button>

      <button class="step-btn step-5" onclick="getCheckSummary()">
        5. ì²´í¬ ìš”ì•½ ì¡°íšŒ
      </button>

      <button class="step-btn step-6" onclick="makePayment()">
        6. ê²°ì œ ì²˜ë¦¬
      </button>
    </div>

    <div>
      <h3>ì‘ë‹µ ê²°ê³¼</h3>
      <div class="response-container" id="responseContainer">
        POS ë°ëª¨ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ìœ„ ë²„íŠ¼ë“¤ì„ ìˆœì„œëŒ€ë¡œ í´ë¦­í•˜ì„¸ìš”.
      </div>
    </div>
  </div>

  <script>
    let currentCheckId = null;
    let currentOrderId = null;
    let lineIds = [];

    function log(message, type = 'info') {
      const container = document.getElementById('responseContainer');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';

      container.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>\n`;
      container.scrollTop = container.scrollHeight;
    }

    async function apiCall(url, options = {}) {
      const storeId = document.getElementById('storeId').value;

      const defaultHeaders = {
        'Content-Type': 'application/json',
        'X-Store-Id': storeId
      };

      const config = {
        ...options,
        headers: {
          ...defaultHeaders,
          ...options.headers
        }
      };

      try {
        log(`ğŸ“¤ ${options.method || 'GET'} ${url}`, 'info');
        if (config.body) {
          log(`   Body: ${config.body}`, 'info');
        }

        const response = await fetch(url, config);
        const data = await response.json();

        if (response.ok) {
          log(`âœ… ${response.status}: ${JSON.stringify(data, null, 2)}`, 'success');
          return data;
        } else {
          log(`âŒ ${response.status}: ${JSON.stringify(data, null, 2)}`, 'error');
          return null;
        }
      } catch (error) {
        log(`âŒ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, 'error');
        return null;
      }
    }

    async function createCheck() {
      const tableNumber = document.getElementById('tableNumber').value;
      const userId = document.getElementById('userId').value;

      const result = await apiCall('/api/tll/checks/from-qr', {
        method: 'POST',
        body: JSON.stringify({
          qr_code: `TABLE_${tableNumber}`,
          user_id: userId || undefined
        })
      });

      if (result) {
        currentCheckId = result.check_id;
        log(`âœ… ì²´í¬ ID ì €ì¥: ${currentCheckId}`, 'success');
      }
    }

    async function createOrder() {
      if (!currentCheckId) {
        log('âŒ ë¨¼ì € ì²´í¬ë¥¼ ìƒì„±í•˜ì„¸ìš”', 'error');
        return;
      }

      const result = await apiCall('/api/tll/orders', {
        method: 'POST',
        headers: {
          'Idempotency-Key': `idem-${Date.now()}`
        },
        body: JSON.stringify({
          check_id: currentCheckId,
          ext_key: `ord-${Date.now()}`
        })
      });

      if (result) {
        currentOrderId = result.order_id;
        log(`âœ… ì£¼ë¬¸ ID ì €ì¥: ${currentOrderId}`, 'success');
      }
    }

    async function addOrderLines() {
      if (!currentOrderId) {
        log('âŒ ë¨¼ì € ì£¼ë¬¸ì„ ìƒì„±í•˜ì„¸ìš”', 'error');
        return;
      }

      const result = await apiCall('/api/tll/order-lines/bulk', {
        method: 'POST',
        body: JSON.stringify({
          order_id: currentOrderId,
          items: [{
            menu_name: "í›„ë¼ì´ë“œ",
            unit_price: 18000,
            count: 2,
            cook_station: "FRY"
          }]
        })
      });

      if (result) {
        lineIds = result.line_ids;
        log(`âœ… ë¼ì¸ IDë“¤ ì €ì¥: ${lineIds.join(', ')}`, 'success');
      }
    }

    async function cancelOneLine() {
      if (lineIds.length === 0) {
        log('âŒ ë¨¼ì € ë¼ì¸ì„ ì¶”ê°€í•˜ì„¸ìš”', 'error');
        return;
      }

      const lineIdToCancel = lineIds[1]; // ë‘ ë²ˆì§¸ ë¼ì¸ ì·¨ì†Œ

      const result = await apiCall(`/api/pos/order-lines/${lineIdToCancel}`, {
        method: 'PATCH',
        body: JSON.stringify({
          status: "canceled"
        })
      });

      if (result) {
        log(`âœ… ë¼ì¸ ${lineIdToCancel} ì·¨ì†Œ ì™„ë£Œ`, 'success');
      }
    }

    async function getCheckSummary() {
      if (!currentCheckId) {
        log('âŒ ë¨¼ì € ì²´í¬ë¥¼ ìƒì„±í•˜ì„¸ìš”', 'error');
        return;
      }

      const result = await apiCall(`/api/pos/checks/${currentCheckId}/summary`);

      if (result) {
        log(`ğŸ“Š ì´ì•¡: â‚©${result.final_total}, ê²°ì œë¨: â‚©${result.paid_total}, ì”ì•¡: â‚©${result.due}`, 'success');
      }
    }

    async function makePayment() {
      if (!currentCheckId) {
        log('âŒ ë¨¼ì € ì²´í¬ë¥¼ ìƒì„±í•˜ì„¸ìš”', 'error');
        return;
      }

      const result = await apiCall('/api/payments', {
        method: 'POST',
        headers: {
          'Idempotency-Key': `idem-pay-${Date.now()}`
        },
        body: JSON.stringify({
          check_id: currentCheckId,
          method: "card",
          amount: 18000
        })
      });

      if (result) {
        log(`ğŸ’³ ê²°ì œ ì™„ë£Œ. ì²´í¬ ìƒíƒœ: ${result.check_status}`, 'success');
      }
    }

    log('ğŸš€ POS ë°ëª¨ ì¤€ë¹„ ì™„ë£Œ', 'success');
  </script>
</body>
</html>