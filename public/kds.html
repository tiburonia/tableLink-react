
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TableLink KDS v3.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* Ìó§Îçî */
        .kds-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #0f3460;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .kds-title {
            font-size: 2rem;
            font-weight: 900;
            color: #00d9ff;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .store-info {
            display: flex;
            gap: 3rem;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .store-info-item {
            display: flex;
            flex-direction: column;
            text-align: center;
            gap: 4px;
        }
        
        .store-info-label {
            font-size: 0.9rem;
            color: #9ca3af;
        }
        
        .store-info-value {
            font-size: 1.1rem;
            color: #ffffff;
            font-weight: 700;
        }
        
        .connection-status.online {
            color: #10b981;
        }
        
        .connection-status.offline {
            color: #ef4444;
            animation: pulse 2s infinite;
        }
        
        /* Ïä§ÌÖåÏù¥ÏÖò ÌÉ≠ */
        .station-tabs {
            background: #1a1a2e;
            padding: 1rem 2rem;
            display: flex;
            gap: 1.5rem;
            border-bottom: 3px solid #0f3460;
            overflow-x: auto;
        }
        
        .station-tab {
            background: #374151;
            color: #d1d5db;
            border: none;
            padding: 1.2rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-width: 140px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .station-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .station-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: #ffffff;
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .station-tab.expo {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .station-tab.expo.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 8px 30px rgba(245, 158, 11, 0.4);
        }
        
        .ticket-counter {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: #ffffff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bounce 2s infinite;
        }
        
        /* Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà */
        .kds-main {
            height: calc(100vh - 180px);
            overflow-y: auto;
            padding: 1.5rem;
            background: #0f0f0f;
        }
        
        /* Ìã∞Ïºì Í∑∏Î¶¨Îìú */
        .tickets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }
        
        /* Ìã∞Ïºì Ïπ¥Îìú */
        .ticket-card {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border-radius: 16px;
            padding: 1.5rem;
            border: 3px solid #374151;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .ticket-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        }
        
        .ticket-card.priority {
            border-color: #ef4444;
            background: linear-gradient(145deg, #1f2937 0%, #2d1b1b 100%);
            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
            animation: priorityPulse 3s infinite;
        }
        
        .ticket-card.ready {
            border-color: #10b981;
            background: linear-gradient(145deg, #1f2937 0%, #1b2d1b 100%);
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        }
        
        .ticket-card.cooking {
            border-color: #f59e0b;
            background: linear-gradient(145deg, #1f2937 0%, #2d2b1b 100%);
            animation: cookingPulse 2s infinite;
        }
        
        /* Ìã∞Ïºì Ìó§Îçî */
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #374151;
        }
        
        .ticket-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .table-number {
            font-size: 2rem;
            font-weight: 900;
            color: #00d9ff;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
            line-height: 1;
        }
        
        .order-id {
            font-size: 1rem;
            color: #9ca3af;
            font-weight: 600;
        }
        
        .customer-name {
            font-size: 1.1rem;
            color: #d1d5db;
            font-weight: 600;
        }
        
        .addon-badge {
            background: #8b5cf6;
            color: #ffffff;
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
            margin-top: 0.5rem;
        }
        
        /* ÏãúÍ∞Ñ Ï†ïÎ≥¥ */
        .ticket-time {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .elapsed-time {
            font-size: 1.8rem;
            font-weight: 900;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .elapsed-time.warning {
            color: #f59e0b;
            animation: timeWarning 1.5s infinite;
        }
        
        .elapsed-time.danger {
            color: #ef4444;
            animation: timeDanger 1s infinite;
        }
        
        .order-time {
            font-size: 0.9rem;
            color: #9ca3af;
            font-weight: 600;
        }
        
        /* Ìã∞Ïºì ÏïÑÏù¥ÌÖú */
        .ticket-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .ticket-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.2rem;
            border-radius: 12px;
            border-left: 6px solid #6b7280;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .ticket-item:hover {
            transform: translateX(4px);
            background: rgba(0, 0, 0, 0.4);
        }
        
        .ticket-item.pending {
            border-left-color: #6b7280;
            background: rgba(107, 114, 128, 0.1);
        }
        
        .ticket-item.cooking {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.15);
            animation: itemCooking 2s infinite;
        }
        
        .ticket-item.done {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
        }
        
        .ticket-item.hold {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
        }
        
        /* ÏïÑÏù¥ÌÖú Ìó§Îçî */
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }
        
        .item-name {
            font-weight: 800;
            font-size: 1.3rem;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .item-quantity {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: #ffffff;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 1.1rem;
            font-weight: 800;
            min-width: 40px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* ÏòµÏÖò Î∞è ÎÖ∏Ìä∏ */
        .item-options {
            font-size: 1rem;
            color: #f59e0b;
            margin-bottom: 0.5rem;
            font-weight: 600;
            line-height: 1.4;
        }
        
        .item-notes {
            font-size: 1rem;
            color: #ef4444;
            font-weight: 700;
            background: rgba(239, 68, 68, 0.1);
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            border: 1px solid #ef4444;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .big-touch-btn {
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .big-touch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        
        .big-touch-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .btn-start {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: #ffffff;
        }
        
        .btn-done {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: #ffffff;
        }
        
        .btn-hold {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #ffffff;
        }
        
        .btn-priority {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: #ffffff;
        }
        
        .btn-expo {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #ffffff;
        }
        
        .btn-bump {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: #ffffff;
        }
        
        .btn-cancel {
            background: #4b5563;
            color: #d1d5db;
        }
        
        /* Ìã∞Ïºì Ïï°ÏÖò */
        .ticket-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .main-action {
            grid-column: 1 / -1;
            font-size: 1.3rem;
            padding: 1.2rem;
            min-height: 64px;
        }
        
        /* ÏïÑÏù¥ÌÖú Ïï°ÏÖò */
        .item-actions {
            display: flex;
            gap: 0.8rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .item-btn {
            background: #4b5563;
            color: #ffffff;
            border: none;
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
            min-width: 80px;
        }
        
        /* EXPO ÌôîÎ©¥ */
        .expo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }
        
        .expo-order {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border-radius: 16px;
            padding: 1.5rem;
            border: 3px solid #10b981;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.2);
        }
        
        .expo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #374151;
        }
        
        .completion-status {
            background: #10b981;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
        }
        
        /* ÏÉÅÌÉú ÏïÑÏù¥ÏΩò */
        .status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            position: relative;
        }
        
        .status-icon.pending {
            background: #6b7280;
        }
        
        .status-icon.cooking {
            background: #f59e0b;
            animation: cookingIcon 1.5s infinite;
        }
        
        .status-icon.done {
            background: #10b981;
        }
        
        .status-icon.hold {
            background: #ef4444;
            animation: holdIcon 2s infinite;
        }
        
        .status-icon.expo {
            background: #f59e0b;
        }
        
        .status-icon.served {
            background: #8b5cf6;
        }
        
        /* Î°úÎî© Î∞è ÏóêÎü¨ */
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 300px;
            color: #9ca3af;
            font-size: 1.2rem;
            gap: 1rem;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #374151;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
        }
        
        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes priorityPulse {
            0%, 100% { border-color: #ef4444; }
            50% { border-color: #fca5a5; }
        }
        
        @keyframes cookingPulse {
            0%, 100% { border-color: #f59e0b; }
            50% { border-color: #fde68a; }
        }
        
        @keyframes cookingIcon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes holdIcon {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes timeWarning {
            0%, 100% { color: #f59e0b; }
            50% { color: #fbbf24; }
        }
        
        @keyframes timeDanger {
            0%, 100% { color: #ef4444; }
            50% { color: #f87171; }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -8px, 0); }
            70% { transform: translate3d(0, -4px, 0); }
            90% { transform: translate3d(0, -2px, 0); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes itemCooking {
            0%, 100% { background: rgba(245, 158, 11, 0.15); }
            50% { background: rgba(245, 158, 11, 0.25); }
        }
        
        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 1200px) {
            .tickets-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .tickets-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .station-tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding: 1rem;
            }
            
            .kds-header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .store-info {
                gap: 1.5rem;
            }
        }
        
        /* ÌÇ§Ïò§Ïä§ÌÅ¨ Î™®Îìú ÏµúÏ†ÅÌôî */
        @media (min-width: 1400px) {
            .tickets-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .ticket-card {
                min-height: 400px;
            }
            
            .big-touch-btn {
                min-height: 64px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="kds-header">
            <div class="kds-title">
                üç≥ TableLink KDS
            </div>
            <div class="store-info">
                <div class="store-info-item">
                    <div class="store-info-label">Îß§Ïû•</div>
                    <div class="store-info-value" id="storeName">Î°úÎî©Ï§ë...</div>
                </div>
                <div class="store-info-item">
                    <div class="store-info-label">ÏãúÍ∞Ñ</div>
                    <div class="store-info-value" id="currentTime">--:--</div>
                </div>
                <div class="store-info-item">
                    <div class="store-info-label">Ïó∞Í≤∞ ÏÉÅÌÉú</div>
                    <div class="store-info-value connection-status" id="connectionStatus">Ïó∞Í≤∞Ï§ë...</div>
                </div>
            </div>
        </div>
        
        <div class="station-tabs" id="stationTabs">
            <!-- Ïä§ÌÖåÏù¥ÏÖò ÌÉ≠Îì§Ïù¥ Ïó¨Í∏∞Ïóê Î†åÎçîÎßÅÎê©ÎãàÎã§ -->
        </div>
        
        <div class="kds-main" id="kdsMain">
            <div class="loading">
                <div class="loading-spinner"></div>
                KDS ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ï§ë...
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ TableLink KDS v3.0 ÏãúÏûë');
        
        class KDSSystem {
            constructor() {
                this.storeId = new URLSearchParams(window.location.search).get('storeId') || '1';
                this.currentStation = null;
                this.stations = [];
                this.tickets = [];
                this.isExpoMode = false;
                this.eventSource = null;
                this.lastUpdate = 0;
                this.timeInterval = null;
                
                this.init();
            }
            
            async init() {
                console.log('üìü KDS Ï¥àÍ∏∞Ìôî ÏãúÏûë, Îß§Ïû• ID:', this.storeId);
                
                try {
                    await this.loadStations();
                    await this.loadTickets();
                    this.setupRealtime();
                    this.startClock();
                    this.setupAutoRefresh();
                    
                    console.log('‚úÖ KDS Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                } catch (error) {
                    console.error('‚ùå KDS Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                    this.showError('KDS ÏãúÏä§ÌÖú Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            }
            
            async loadStations() {
                try {
                    const response = await fetch(`/api/kds/stations?store_id=${this.storeId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.stations = data.stations;
                        this.renderStationTabs();
                        
                        // Ï≤´ Î≤àÏß∏ Ïä§ÌÖåÏù¥ÏÖòÏùÑ Í∏∞Î≥∏ÏúºÎ°ú ÏÑ†ÌÉù
                        if (this.stations.length > 0) {
                            this.selectStation(this.stations[0].id);
                        }
                        
                        // Îß§Ïû• Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏
                        const storeName = this.stations[0]?.store_id ? `Îß§Ïû• ${this.stations[0].store_id}` : 'ÌÖåÏä§Ìä∏ Îß§Ïû•';
                        document.getElementById('storeName').textContent = storeName;
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('‚ùå Ïä§ÌÖåÏù¥ÏÖò Î°úÎî© Ïã§Ìå®:', error);
                    this.showError('Ïä§ÌÖåÏù¥ÏÖò Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
            }
            
            renderStationTabs() {
                const tabsContainer = document.getElementById('stationTabs');
                
                const tabs = this.stations.map(station => {
                    const isExpo = station.is_expo;
                    const ticketCount = station.active_tickets || 0;
                    
                    return `
                        <button 
                            class="station-tab ${isExpo ? 'expo' : ''}" 
                            onclick="kds.selectStation(${station.id})"
                            data-station="${station.id}"
                        >
                            ${station.name}
                            ${ticketCount > 0 ? `<span class="ticket-counter">${ticketCount}</span>` : ''}
                        </button>
                    `;
                }).join('');
                
                tabsContainer.innerHTML = tabs;
            }
            
            selectStation(stationId) {
                this.currentStation = stationId;
                this.isExpoMode = this.stations.find(s => s.id === stationId)?.is_expo || false;
                
                // ÌÉ≠ ÌôúÏÑ±Ìôî
                document.querySelectorAll('.station-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const activeTab = document.querySelector(`[data-station="${stationId}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
                
                this.loadTickets();
            }
            
            async loadTickets() {
                try {
                    const endpoint = this.isExpoMode 
                        ? `/api/kds/expo?store_id=${this.storeId}&updated_since=${this.lastUpdate}`
                        : `/api/kds/tickets?store_id=${this.storeId}&station_id=${this.currentStation}&updated_since=${this.lastUpdate}`;
                    
                    const response = await fetch(endpoint);
                    const data = await response.json();
                    
                    if (data.success) {
                        if (this.isExpoMode) {
                            this.renderExpoView(data.expo_items);
                        } else {
                            this.tickets = data.tickets;
                            this.renderTickets();
                        }
                        this.lastUpdate = data.timestamp;
                        
                        // Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                        const statusEl = document.getElementById('connectionStatus');
                        statusEl.textContent = 'Ï†ïÏÉÅ Ïó∞Í≤∞';
                        statusEl.className = 'store-info-value connection-status online';
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('‚ùå Ìã∞Ïºì Î°úÎî© Ïã§Ìå®:', error);
                    
                    // Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    const statusEl = document.getElementById('connectionStatus');
                    statusEl.textContent = 'Ïó∞Í≤∞ Ïã§Ìå®';
                    statusEl.className = 'store-info-value connection-status offline';
                    
                    this.showError('Ìã∞Ïºì Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
            }
            
            renderTickets() {
                const mainContainer = document.getElementById('kdsMain');
                
                if (this.tickets.length === 0) {
                    mainContainer.innerHTML = `
                        <div class="loading">
                            <div style="font-size: 3rem;">üçΩÔ∏è</div>
                            ÌòÑÏû¨ Ï≤òÎ¶¨Ìï† Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§
                        </div>
                    `;
                    return;
                }
                
                // ÏÉÅÌÉúÎ≥ÑÎ°ú Ìã∞Ïºì Ï†ïÎ†¨ (PENDING ‚Üí COOKING ‚Üí DONE)
                const sortedTickets = this.tickets.sort((a, b) => {
                    const statusOrder = { 'PENDING': 0, 'COOKING': 1, 'DONE': 2 };
                    const aStatus = this.getTicketMainStatus(a);
                    const bStatus = this.getTicketMainStatus(b);
                    
                    if (aStatus !== bStatus) {
                        return (statusOrder[aStatus] || 99) - (statusOrder[bStatus] || 99);
                    }
                    
                    // Í∞ôÏùÄ ÏÉÅÌÉúÎ©¥ Ïö∞ÏÑ†ÏàúÏúÑÏàú, Í∑∏ Îã§Ïùå ÏÉùÏÑ±ÏãúÍ∞ÑÏàú
                    if (a.priority !== b.priority) {
                        return b.priority - a.priority;
                    }
                    
                    return new Date(a.created_at) - new Date(b.created_at);
                });
                
                const ticketsHtml = sortedTickets.map(ticket => this.renderTicket(ticket)).join('');
                
                mainContainer.innerHTML = `
                    <div class="tickets-grid">
                        ${ticketsHtml}
                    </div>
                `;
            }
            
            getTicketMainStatus(ticket) {
                const items = ticket.items || [];
                if (items.every(item => item.kds_status === 'DONE')) return 'DONE';
                if (items.some(item => item.kds_status === 'COOKING')) return 'COOKING';
                return 'PENDING';
            }
            
            renderTicket(ticket) {
                const elapsedTime = this.getElapsedTime(ticket.created_at);
                const isReady = ticket.ticket_status === 'READY';
                const isPriority = ticket.priority > 0;
                const mainStatus = this.getTicketMainStatus(ticket);
                
                const itemsHtml = ticket.items.map(item => this.renderTicketItem(item)).join('');
                
                return `
                    <div class="ticket-card ${isPriority ? 'priority' : ''} ${isReady ? 'ready' : ''} ${mainStatus.toLowerCase()}" onclick="kds.quickAction(${ticket.ticket_id})">
                        <div class="ticket-header">
                            <div class="ticket-info">
                                <div class="table-number">ü™ë ${ticket.table_number}</div>
                                <div class="order-id">#${ticket.ticket_id.toString().padStart(3, '0')}</div>
                                ${ticket.customer_name ? `<div class="customer-name">${ticket.customer_name}</div>` : ''}
                                <div class="order-id">${ticket.source_system} | Course ${ticket.course_no}</div>
                                ${ticket.course_no > 1 ? '<div class="addon-badge">ADD-ON</div>' : ''}
                            </div>
                            <div class="ticket-time">
                                <div class="elapsed-time ${elapsedTime.class}">${elapsedTime.text}</div>
                                <div class="order-time">${new Date(ticket.created_at).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}</div>
                            </div>
                        </div>
                        
                        <div class="ticket-items">
                            ${itemsHtml}
                        </div>
                        
                        <div class="ticket-actions">
                            ${this.renderTicketActions(ticket)}
                        </div>
                    </div>
                `;
            }
            
            renderTicketItem(item) {
                const statusIcon = `<span class="status-icon ${item.kds_status.toLowerCase()}"></span>`;
                const options = item.options && Object.keys(item.options).length > 0 
                    ? Object.entries(item.options).map(([k, v]) => `${k}: ${v}`).join(' | ')
                    : '';
                
                return `
                    <div class="ticket-item ${item.kds_status.toLowerCase()}" onclick="event.stopPropagation(); kds.itemQuickAction(${item.item_id})">
                        <div class="item-header">
                            <div class="item-name">
                                ${statusIcon}${item.menu_name}
                            </div>
                            <div class="item-quantity">√ó${item.quantity}</div>
                        </div>
                        ${options ? `<div class="item-options">üîß ${options}</div>` : ''}
                        ${item.notes ? `<div class="item-notes">‚ö†Ô∏è ${item.notes}</div>` : ''}
                    </div>
                `;
            }
            
            renderTicketActions(ticket) {
                const mainStatus = this.getTicketMainStatus(ticket);
                const isReady = ticket.ticket_status === 'READY';
                
                let mainButton = '';
                let secondaryButtons = '';
                
                switch (mainStatus) {
                    case 'PENDING':
                        mainButton = `<button class="big-touch-btn main-action btn-start" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'start_all')">üî• Ï†ÑÏ≤¥ Ï°∞Î¶¨ ÏãúÏûë</button>`;
                        secondaryButtons = `
                            <button class="big-touch-btn btn-priority" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'raise_priority')">‚ö° Ïö∞ÏÑ†Ï≤òÎ¶¨</button>
                            <button class="big-touch-btn btn-hold" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'hold_all')">‚è∏Ô∏è Ï†ÑÏ≤¥Î≥¥Î•ò</button>
                        `;
                        break;
                        
                    case 'COOKING':
                        mainButton = `<button class="big-touch-btn main-action btn-done" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'complete_all')">‚úÖ Ï†ÑÏ≤¥ ÏôÑÎ£å</button>`;
                        secondaryButtons = `
                            <button class="big-touch-btn btn-priority" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'raise_priority')">‚ö° Ïö∞ÏÑ†Ï≤òÎ¶¨</button>
                            <button class="big-touch-btn btn-hold" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'hold_all')">‚è∏Ô∏è Ï†ÑÏ≤¥Î≥¥Î•ò</button>
                        `;
                        break;
                        
                    case 'DONE':
                        if (this.isExpoMode || isReady) {
                            mainButton = `<button class="big-touch-btn main-action btn-bump" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'bump')">üéØ BUMP (ÏÑúÎπôÏôÑÎ£å)</button>`;
                            secondaryButtons = `
                                <button class="big-touch-btn btn-expo" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'expo_all')">üì§ EXPO Ïù¥Îèô</button>
                                <button class="big-touch-btn btn-priority" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'raise_priority')">‚ö° Ïö∞ÏÑ†Ï≤òÎ¶¨</button>
                            `;
                        } else {
                            mainButton = `<button class="big-touch-btn main-action btn-expo" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'expo_all')">üì§ EXPOÎ°ú Ï†ÑÏÜ°</button>`;
                            secondaryButtons = `
                                <button class="big-touch-btn btn-priority" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'raise_priority')">‚ö° Ïö∞ÏÑ†Ï≤òÎ¶¨</button>
                                <button class="big-touch-btn btn-cancel" onclick="event.stopPropagation(); kds.ticketAction(${ticket.ticket_id}, 'cancel_all')">‚ùå Ï£ºÎ¨∏Ï∑®ÏÜå</button>
                            `;
                        }
                        break;
                }
                
                return mainButton + secondaryButtons;
            }
            
            renderExpoView(expoItems) {
                const mainContainer = document.getElementById('kdsMain');
                
                if (expoItems.length === 0) {
                    mainContainer.innerHTML = `
                        <div class="loading">
                            <div style="font-size: 3rem;">üì§</div>
                            ÌîΩÏóÖ ÎåÄÍ∏∞Ï§ëÏù∏ Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§
                        </div>
                    `;
                    return;
                }
                
                const ordersHtml = expoItems.map(order => {
                    const readyItems = order.items.filter(item => item.kds_status === 'DONE');
                    const totalItems = order.items.length;
                    const allReady = readyItems.length === totalItems;
                    
                    return `
                        <div class="expo-order ${allReady ? 'ready' : ''}">
                            <div class="expo-header">
                                <div>
                                    <div class="table-number">ü™ë ÌÖåÏù¥Î∏î ${order.table_number}</div>
                                    ${order.customer_name ? `<div class="customer-name">${order.customer_name}</div>` : ''}
                                </div>
                                <div class="completion-status">
                                    ${readyItems.length}/${totalItems} ÏôÑÎ£å
                                </div>
                            </div>
                            
                            <div class="ticket-items">
                                ${order.items.map(item => `
                                    <div class="ticket-item ${item.kds_status.toLowerCase()}">
                                        <div class="item-header">
                                            <div class="item-name">
                                                <span class="status-icon ${item.kds_status.toLowerCase()}"></span>
                                                ${item.menu_name}
                                                <span style="color: #9ca3af; font-size: 0.9rem;">(${item.station_name})</span>
                                            </div>
                                            <div class="item-quantity">√ó${item.quantity}</div>
                                        </div>
                                        ${item.kds_status === 'DONE' ? `
                                            <button class="big-touch-btn btn-bump" onclick="kds.itemAction(${item.item_id}, 'served')" style="margin-top: 1rem; width: 100%;">
                                                üéØ ÏÑúÎπôÏôÑÎ£å
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${allReady ? `
                                <button class="big-touch-btn main-action btn-bump" onclick="kds.completeOrder(${order.check_id})" style="margin-top: 1rem;">
                                    üéØ Ï†ÑÏ≤¥ ÏÑúÎπôÏôÑÎ£å (BUMP)
                                </button>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
                mainContainer.innerHTML = `
                    <div class="expo-grid">
                        ${ordersHtml}
                    </div>
                `;
            }
            
            // Ìã∞Ïºì Ïπ¥Îìú ÌÅ¥Î¶≠Ïãú Îπ†Î•∏ Ïï°ÏÖò
            quickAction(ticketId) {
                const ticket = this.tickets.find(t => t.ticket_id === ticketId);
                if (!ticket) return;
                
                const mainStatus = this.getTicketMainStatus(ticket);
                
                switch (mainStatus) {
                    case 'PENDING':
                        this.ticketAction(ticketId, 'start_all');
                        break;
                    case 'COOKING':
                        this.ticketAction(ticketId, 'complete_all');
                        break;
                    case 'DONE':
                        if (this.isExpoMode) {
                            this.ticketAction(ticketId, 'bump');
                        } else {
                            this.ticketAction(ticketId, 'expo_all');
                        }
                        break;
                }
            }
            
            // ÏïÑÏù¥ÌÖú ÌÅ¥Î¶≠Ïãú Îπ†Î•∏ Ïï°ÏÖò
            itemQuickAction(itemId) {
                const allItems = this.tickets.flatMap(t => t.items);
                const item = allItems.find(i => i.item_id === itemId);
                if (!item) return;
                
                switch (item.kds_status) {
                    case 'PENDING':
                        this.itemAction(itemId, 'start');
                        break;
                    case 'COOKING':
                        this.itemAction(itemId, 'done');
                        break;
                    case 'DONE':
                        if (this.isExpoMode) {
                            this.itemAction(itemId, 'served');
                        } else {
                            this.itemAction(itemId, 'expo');
                        }
                        break;
                }
            }
            
            async itemAction(itemId, action) {
                try {
                    const response = await fetch(`/api/kds/items/${itemId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log(`‚úÖ ÏïÑÏù¥ÌÖú Ïï°ÏÖò ÏôÑÎ£å: ${action}`);
                        this.showToast(`ÏïÑÏù¥ÌÖú ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§`);
                        setTimeout(() => this.loadTickets(), 500);
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('‚ùå ÏïÑÏù¥ÌÖú Ïï°ÏÖò Ïã§Ìå®:', error);
                    this.showToast('ÏûëÏóÖÏùÑ ÏôÑÎ£åÌï† Ïàò ÏóÜÏäµÎãàÎã§', true);
                }
            }
            
            async ticketAction(ticketId, action) {
                try {
                    const response = await fetch(`/api/kds/tickets/${ticketId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log(`‚úÖ Ìã∞Ïºì Ïï°ÏÖò ÏôÑÎ£å: ${action}`);
                        this.showToast(`Ìã∞Ïºì ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§`);
                        setTimeout(() => this.loadTickets(), 500);
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('‚ùå Ìã∞Ïºì Ïï°ÏÖò Ïã§Ìå®:', error);
                    this.showToast('ÏûëÏóÖÏùÑ ÏôÑÎ£åÌï† Ïàò ÏóÜÏäµÎãàÎã§', true);
                }
            }
            
            async completeOrder(checkId) {
                try {
                    // Ï≤¥ÌÅ¨Ïùò Î™®Îì† ÏïÑÏù¥ÌÖúÏùÑ SERVEDÎ°ú Î≥ÄÍ≤Ω
                    const orderItems = this.tickets
                        .filter(t => t.check_id === checkId)
                        .flatMap(t => t.items)
                        .filter(i => i.kds_status === 'DONE');
                    
                    for (const item of orderItems) {
                        await this.itemAction(item.item_id, 'served');
                    }
                    
                    this.showToast(`ÌÖåÏù¥Î∏î ${checkId} Ï£ºÎ¨∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§`);
                } catch (error) {
                    console.error('‚ùå Ï£ºÎ¨∏ ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®:', error);
                    this.showToast('Ï£ºÎ¨∏ ÏôÑÎ£å Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§', true);
                }
            }
            
            setupRealtime() {
                if (this.eventSource) {
                    this.eventSource.close();
                }
                
                this.eventSource = new EventSource(`/api/kds/stream/${this.storeId}`);
                
                this.eventSource.onopen = () => {
                    console.log('üîå KDS Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞ ÏÑ±Í≥µ');
                };
                
                this.eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'update') {
                            console.log('üì° Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏:', data);
                            this.loadTickets();
                            this.loadStations(); // Ïπ¥Ïö¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                        }
                    } catch (error) {
                        console.error('‚ùå Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ïã§Ìå®:', error);
                    }
                };
                
                this.eventSource.onerror = () => {
                    console.error('‚ùå KDS Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞ Ïã§Ìå®');
                    
                    const statusEl = document.getElementById('connectionStatus');
                    statusEl.textContent = 'Ïó∞Í≤∞ Ïã§Ìå®';
                    statusEl.className = 'store-info-value connection-status offline';
                    
                    // ÏûêÎèô Ïû¨Ïó∞Í≤∞
                    setTimeout(() => {
                        this.setupRealtime();
                    }, 5000);
                };
            }
            
            setupAutoRefresh() {
                // 3Ï¥àÎßàÎã§ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
                setInterval(() => {
                    this.loadTickets();
                    this.loadStations();
                }, 3000);
            }
            
            getElapsedTime(createdAt) {
                const elapsed = Math.floor((Date.now() - new Date(createdAt).getTime()) / 1000 / 60);
                
                let className = '';
                if (elapsed > 15) className = 'danger';
                else if (elapsed > 10) className = 'warning';
                
                return {
                    text: `${elapsed}Î∂Ñ`,
                    class: className
                };
            }
            
            startClock() {
                const updateTime = () => {
                    const now = new Date();
                    document.getElementById('currentTime').textContent = 
                        now.toLocaleTimeString('ko-KR', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                };
                
                updateTime();
                this.timeInterval = setInterval(updateTime, 1000);
            }
            
            showError(message) {
                document.getElementById('kdsMain').innerHTML = `
                    <div class="error">
                        ‚ùå ${message}
                    </div>
                `;
            }
            
            showToast(message, isError = false) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${isError ? '#ef4444' : '#10b981'};
                    color: white;
                    padding: 1rem 2rem;
                    border-radius: 8px;
                    font-size: 1.1rem;
                    font-weight: 600;
                    z-index: 1000;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    animation: slideDown 0.3s ease;
                `;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
            
            destroy() {
                if (this.eventSource) {
                    this.eventSource.close();
                }
                if (this.timeInterval) {
                    clearInterval(this.timeInterval);
                }
            }
        }
        
        // Ï†ÑÏó≠ KDS Ïù∏Ïä§ÌÑ¥Ïä§
        let kds;
        
        document.addEventListener('DOMContentLoaded', () => {
            kds = new KDSSystem();
        });
        
        // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìúÏãú Ï†ïÎ¶¨
        window.addEventListener('beforeunload', () => {
            if (kds) {
                kds.destroy();
            }
        });
        
        // Ï∂îÍ∞Ä Ïï†ÎãàÎ©îÏù¥ÏÖò Ïä§ÌÉÄÏùº
        const additionalStyles = document.createElement('style');
        additionalStyles.textContent = `
            @keyframes slideDown {
                from { transform: translateX(-50%) translateY(-50px); opacity: 0; }
                to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
            
            @keyframes slideUp {
                from { transform: translateX(-50%) translateY(0); opacity: 1; }
                to { transform: translateX(-50%) translateY(-50px); opacity: 0; }
            }
        `;
        document.head.appendChild(additionalStyles);
    </script>
</body>
</html>
