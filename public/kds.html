<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDS - Kitchen Display System</title>
    <link rel="icon" type="image/png" href="/TableLink.png">

    <!-- Socket.IO ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ -->
    <script src="/socket.io/socket.io.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .loading-sub {
            font-size: 16px;
            color: #bdc3c7;
        }

        .store-selector {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        .selector-content {
            background: white;
            color: #2c3e50;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .selector-title {
            font-size: 28px;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .selector-subtitle {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .store-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
        }

        .store-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .start-btn {
            width: 100%;
            padding: 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .start-btn:hover {
            background: #2980b9;
        }

        .start-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            padding: 10px;
            background: #fdedec;
            border-radius: 8px;
            display: none;
        }

        #main {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="main">
        <!-- Î°úÎî© ÌôîÎ©¥ -->
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-icon">üç≥</div>
            <div class="loading-text">KDS ÏãúÏä§ÌÖú Î°úÎî© Ï§ë...</div>
            <div class="loading-sub">Kitchen Display System</div>
        </div>

        <!-- Îß§Ïû• ÏÑ†ÌÉù ÌôîÎ©¥ -->
        <div class="store-selector" id="storeSelector" style="display: none;">
            <div class="selector-content">
                <h1 class="selector-title">üç≥ KDS ÏãúÏä§ÌÖú</h1>
                <p class="selector-subtitle">Îß§Ïû• IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>

                <input
                    type="number"
                    id="storeIdInput"
                    class="store-input"
                    placeholder="Îß§Ïû• ID (Ïòà: 1)"
                    min="1"
                >

                <button id="startKdsBtn" class="start-btn">
                    KDS ÏãúÏûëÌïòÍ∏∞
                </button>

                <div id="errorMessage" class="error-message"></div>
            </div>
        </div>
    </div>

    <!-- KDS Ïª¥Ìè¨ÎÑåÌä∏ Î°úÎìú -->
    <script src="/KDS/components/renderKDS.js" onerror="console.error('‚ùå KDS Ïª¥Ìè¨ÎÑåÌä∏ Î°úÎìú Ïã§Ìå®')"></script>

    <script>
        let currentStoreId = null;

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üç≥ KDS ÌéòÏù¥ÏßÄ Î°úÎìú');

            // URLÏóêÏÑú Îß§Ïû• ID ÌôïÏù∏
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('store') || urlParams.get('storeId');

            if (storeId && !isNaN(storeId)) {
                // URLÏóê Îß§Ïû• IDÍ∞Ä ÏûàÏúºÎ©¥ Î∞îÎ°ú ÏãúÏûë
                await startKDS(parseInt(storeId));
            } else {
                // Îß§Ïû• ÏÑ†ÌÉù ÌôîÎ©¥ ÌëúÏãú
                showStoreSelector();
            }
        });

        // Îß§Ïû• ÏÑ†ÌÉù ÌôîÎ©¥ ÌëúÏãú
        function showStoreSelector() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('storeSelector').style.display = 'flex';

            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            const storeInput = document.getElementById('storeIdInput');
            const startBtn = document.getElementById('startKdsBtn');
            const errorDiv = document.getElementById('errorMessage');

            storeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    startBtn.click();
                }
            });

            startBtn.addEventListener('click', async () => {
                const storeId = parseInt(storeInput.value);

                if (!storeId || storeId < 1) {
                    showError('Ïò¨Î∞îÎ•∏ Îß§Ïû• IDÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                await startKDS(storeId);
            });

            // Ìè¨Ïª§Ïä§
            storeInput.focus();
        }

        // KDS ÏãúÏûë
        async function startKDS(storeId) {
            try {
                console.log(`üç≥ KDS ÏãúÏûë - Îß§Ïû• ${storeId}`);

                currentStoreId = storeId;

                // UI Ïà®Í∏∞Í∏∞
                document.getElementById('storeSelector').style.display = 'none';
                document.getElementById('loadingScreen').style.display = 'flex';

                // URL ÏóÖÎç∞Ïù¥Ìä∏
                const newUrl = `${window.location.pathname}?store=${storeId}`;
                window.history.replaceState(null, '', newUrl);

                // KDS Ïª¥Ìè¨ÎÑåÌä∏ Î°úÎìú ÎåÄÍ∏∞
                let retryCount = 0;
                const maxRetries = 10;

                while (typeof renderKDS !== 'function' && retryCount < maxRetries) {
                  console.log(`üîÑ KDS Ïª¥Ìè¨ÎÑåÌä∏ Î°úÎìú ÎåÄÍ∏∞... (${retryCount + 1}/${maxRetries})`);
                  await new Promise(resolve => setTimeout(resolve, 100));
                  retryCount++;
                }

                // KDS Î†åÎçîÎßÅ
                if (typeof renderKDS === 'function') {
                  await renderKDS(storeId);
                  // Î°úÎî© Ïà®Í∏∞Í∏∞
                  const loadingElement = document.getElementById('loadingScreen');
                  if (loadingElement) {
                    loadingElement.style.display = 'none';
                  }
                } else {
                  throw new Error(`KDS Ïª¥Ìè¨ÎÑåÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§ (${maxRetries}Ìöå Ïû¨ÏãúÎèÑ ÌõÑ Ïã§Ìå®)`);
                }

            } catch (error) {
                console.error('‚ùå KDS ÏãúÏûë Ïã§Ìå®:', error);
                showError('KDS ÏãúÏä§ÌÖúÏùÑ ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§: ' + error.message);
                showStoreSelector();
            }
        }

        // Ïò§Î•ò ÌëúÏãú
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
              errorElement.textContent = message;
            } else {
              console.error('‚ùå KDS Ïò§Î•ò:', message);
              alert('KDS Ïò§Î•ò: ' + message);
            }

            // Ïò§Î•ò Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞ ÌÉÄÏù¥Î®∏ (if errorElement exists)
            if (errorElement) {
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
        }

        // ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ® Îã®Ï∂ïÌÇ§
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                if (currentStoreId) {
                    startKDS(currentStoreId);
                } else {
                    location.reload();
                }
            }
        });

        // Ï†ÑÏ≤¥ÌôîÎ©¥ ÌÜ†Í∏Ä
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F11') {
                e.preventDefault();
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    document.documentElement.requestFullscreen();
                }
            }
        });
    </script>
</body>
</html>