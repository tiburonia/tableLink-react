<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì œ ì²˜ë¦¬ ì¤‘</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { 
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        h1 { 
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .loading {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background 0.2s;
        }
        .btn:hover { background: #5a6fd8; }
        .btn.secondary {
            background: #6c757d;
        }
        .btn.secondary:hover { background: #5a6268; }
        .error-container {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success-content {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ê²°ì œ ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘</h1>
        <div class="loading">í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
        <div class="spinner"></div>
    </div>

    <script>
        // ë©”ì¸ìœ¼ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function goToMain() {
            try {
                // ë¶€ëª¨ ì°½ì´ ìˆëŠ” ê²½ìš° (íŒì—…ì—ì„œ ì—´ë¦° ê²½ìš°)
                if (window.opener && window.opener !== window) {
                    // ë¶€ëª¨ ì°½ì— ë©”ì‹œì§€ ì „ì†¡
                    window.opener.postMessage({ 
                        type: 'PAYMENT_SUCCESS', 
                        action: 'GO_TO_MAIN' 
                    }, '*');
                    window.close();
                } else {
                    // ì§ì ‘ ì ‘ê·¼í•œ ê²½ìš°
                    window.location.href = '/?redirect=map';
                }
            } catch (error) {
                console.error('ë©”ì¸ ì´ë™ ì‹¤íŒ¨:', error);
                window.location.href = '/';
            }
        }

        // ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function goToMyPage() {
            try {
                if (window.opener && window.opener !== window) {
                    window.opener.postMessage({ 
                        type: 'PAYMENT_SUCCESS', 
                        action: 'GO_TO_MYPAGE' 
                    }, '*');
                    window.close();
                } else {
                    window.location.href = '/?redirect=mypage';
                }
            } catch (error) {
                console.error('ë§ˆì´í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨:', error);
                window.location.href = '/';
            }
        }

        function showSuccessPage(paymentKey, orderId, amount, orderResult = null) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="success-content">
                    <div style="font-size: 64px; margin-bottom: 20px;">âœ…</div>
                    <h1>ê²°ì œ ì™„ë£Œ!</h1>
                    <p>ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: left;">
                        <h3>ì£¼ë¬¸ ì •ë³´</h3>
                        <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${orderId}</p>
                        <p><strong>ê²°ì œê¸ˆì•¡:</strong> ${parseInt(amount).toLocaleString()}ì›</p>
                        ${orderResult ? `<p><strong>ì ë¦½í¬ì¸íŠ¸:</strong> ${Math.floor(amount * 0.1).toLocaleString()}P</p>` : ''}
                    </div>

                    <div class="action-buttons">
                        <button onclick="goToMain()" class="btn primary">ë©”ì¸ìœ¼ë¡œ</button>
                        <button onclick="goToMyPage()" class="btn secondary">ì£¼ë¬¸ë‚´ì—­ ë³´ê¸°</button>
                    </div>
                </div>
            `;

            // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ë©”ì¸ìœ¼ë¡œ ì´ë™
            setTimeout(() => {
                console.log('ğŸ’³ ê²°ì œ ì„±ê³µ - ìë™ìœ¼ë¡œ ì§€ë„ í™”ë©´ìœ¼ë¡œ ì´ë™');
                goToMain();
            }, 3000);
        }

        function showErrorPage(error) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 20px;">âŒ</div>
                <h1>ê²°ì œ ì‹¤íŒ¨</h1>
                <div class="error-container">
                    <h2>ì˜¤ë¥˜ ë°œìƒ</h2>
                    <p>${error.message || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</p>
                </div>
                <button class="btn" onclick="goToMain()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>
            `;
        }

        async function processPayment() {
            try {
                // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê²°ì œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const urlParams = new URLSearchParams(window.location.search);
                const paymentKey = urlParams.get('paymentKey');
                const orderId = urlParams.get('orderId');
                const amount = urlParams.get('amount');

                console.log('ğŸ“‹ URL íŒŒë¼ë¯¸í„°:', { paymentKey, orderId, amount });

                if (!paymentKey || !orderId || !amount) {
                    throw new Error('ê²°ì œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                // ë¡œë”© ìƒíƒœ ì—…ë°ì´íŠ¸
                const container = document.querySelector('.container');
                const h1 = container.querySelector('h1');
                const loading = container.querySelector('.loading');
                if (h1) h1.textContent = 'ê²°ì œ ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘';
                if (loading) loading.textContent = 'í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

                // í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ìŠ¹ì¸ ìš”ì²­
                const confirmResponse = await fetch('/api/toss/success', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        paymentKey,
                        orderId,
                        amount: parseInt(amount)
                    })
                });

                const confirmResult = await confirmResponse.json();

                if (!confirmResult.success) {
                    throw new Error(confirmResult.error || 'í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                console.log('âœ… í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ìŠ¹ì¸ ì™„ë£Œ:', confirmResult);

                // sessionStorageì—ì„œ ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                let pendingOrderData = null;
                try {
                    const storedData = sessionStorage.getItem('pendingOrderData');
                    if (storedData) {
                        pendingOrderData = JSON.parse(storedData);
                        console.log('ğŸ“¦ ì €ì¥ëœ ì£¼ë¬¸ ë°ì´í„° ë³µì›:', pendingOrderData);
                    }
                } catch (error) {
                    console.warn('âš ï¸ ì£¼ë¬¸ ë°ì´í„° ë³µì› ì‹¤íŒ¨:', error);
                }

                // ì£¼ë¬¸ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ê²°ì œ ì™„ë£Œ ì²˜ë¦¬
                if (pendingOrderData) {
                    console.log('ğŸ”„ ê²°ì œ ì™„ë£Œ API í˜¸ì¶œ ì‹œì‘');

                    const paymentResponse = await fetch('/api/orders/pay', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...pendingOrderData,
                            pgPaymentKey: paymentKey,
                            pgOrderId: orderId,
                            pgPaymentMethod: 'CARD'
                        })
                    });

                    if (paymentResponse.ok) {
                        const orderResult = await paymentResponse.json();
                        console.log('âœ… ì£¼ë¬¸ ì²˜ë¦¬ ì™„ë£Œ:', orderResult);

                        // ì£¼ë¬¸ ë°ì´í„° ì •ë¦¬
                        sessionStorage.removeItem('pendingOrderData');

                        // ì„±ê³µ í˜ì´ì§€ í‘œì‹œ
                        showSuccessPage(paymentKey, orderId, amount, orderResult);
                    } else {
                        const errorData = await paymentResponse.json();
                        throw new Error(errorData.error || 'ì£¼ë¬¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    console.warn('âš ï¸ ì£¼ë¬¸ ë°ì´í„° ì—†ìŒ - PG ê²°ì œ ì„±ê³µë§Œ ì²˜ë¦¬');
                    showSuccessPage(paymentKey, orderId, amount);
                }

            } catch (error) {
                console.error('âŒ ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                showErrorPage(error);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê²°ì œ ì²˜ë¦¬ ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(processPayment, 500);
        });
    </script>
</body>
</html>