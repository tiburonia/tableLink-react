
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì œ ì™„ë£Œ - TableLink</title>
    <link rel="stylesheet" href="/shared/css/toss-success.css">
</head>
<body>
    <div class="container">
        <div class="status-icon">â³</div>
        <h1>ê²°ì œ ì²˜ë¦¬ ì¤‘...</h1>
        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <script>
        // URL íŒŒë¼ë¯¸í„° íŒŒì‹± í•¨ìˆ˜
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                paymentKey: urlParams.get('paymentKey'),
                orderId: urlParams.get('orderId'),
                amount: urlParams.get('amount')
            };
        }

        // ìƒíƒœ í‘œì‹œ í•¨ìˆ˜
        function showStatus(message) {
            const container = document.querySelector('.container');
            if (container) {
                container.innerHTML = `
                    <div class="status-icon">â³</div>
                    <h1>${message}</h1>
                    <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                `;
            }
        }

        // ì„±ê³µ í‘œì‹œ í•¨ìˆ˜
        function showSuccess(data) {
            const { orderId, amount } = data;
            const container = document.querySelector('.container');
            if (container) {
                container.innerHTML = `
                    <div class="status-icon">âœ…</div>
                    <h1>ê²°ì œ ì™„ë£Œ!</h1>
                    <div class="success-info">
                        <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${orderId}</p>
                        <p><strong>ê²°ì œê¸ˆì•¡:</strong> â‚©${parseInt(amount).toLocaleString()}</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn primary" onclick="goBack()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>
                `;
            }
        }

        // ì—ëŸ¬ í‘œì‹œ í•¨ìˆ˜
        function showError(message) {
            const container = document.querySelector('.container');
            if (container) {
                container.innerHTML = `
                    <div class="status-icon">âŒ</div>
                    <h1>ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨</h1>
                    <div class="error-info">
                        <p>${message}</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn primary" onclick="goBack()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>
                `;
            }
        }

        // TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬
        async function processTLLPaymentSuccess() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const paymentKey = urlParams.get('paymentKey');
                const orderId = urlParams.get('orderId');
                const amount = urlParams.get('amount');
                const isGuest = urlParams.get('isGuest') === 'true';

                if (!paymentKey || !orderId || !amount) {
                    throw new Error('ê²°ì œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                console.log('ğŸ”„ TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬ ì‹œì‘:', { paymentKey, orderId, amount, isGuest });
                showStatus('ê²°ì œ ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘...');

                // ë¹„íšŒì›/íšŒì›ì— ë”°ë¼ API ì—”ë“œí¬ì¸íŠ¸ ì„ íƒ
                const apiEndpoint = isGuest ? '/api/toss/confirm-guest' : '/api/toss/confirm';
                console.log(`ğŸ“¡ API í˜¸ì¶œ: ${apiEndpoint}`);

                // í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ìŠ¹ì¸ ì§ì ‘ í˜¸ì¶œ
                const confirmResponse = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentKey, orderId, amount: parseInt(amount) })
                });

                if (!confirmResponse.ok) {
                    const errorData = await confirmResponse.json();
                    throw new Error(errorData.error || 'ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨');
                }

                const result = await confirmResponse.json();
                console.log('âœ… ê²°ì œ ìŠ¹ì¸ ì™„ë£Œ:', result);

                showSuccess({ paymentKey, orderId, amount });

            } catch (error) {
                console.error('âŒ TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                showError(`ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // TableLinkë¡œ ëŒì•„ê°€ê¸°
        function goBack() {
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.location.href = '/';
                    window.close();
                } else {
                    window.location.href = '/';
                }
            } catch (e) {
                window.location.href = '/';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        console.log('ğŸ“± ê²°ì œ ì„±ê³µ í˜ì´ì§€ ë¡œë“œ');
        document.addEventListener('DOMContentLoaded', () => {
            processTLLPaymentSuccess();
        });
    </script>
</body>
</html>
