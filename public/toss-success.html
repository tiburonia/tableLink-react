
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì œ ì™„ë£Œ - TableLink</title>
    <link rel="stylesheet" href="/shared/css/toss-success.css">
</head>
<body>
    <div class="container">
        <div class="status-icon">â³</div>
        <h1>ê²°ì œ ì²˜ë¦¬ ì¤‘...</h1>
        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <script>
        // URL íŒŒë¼ë¯¸í„° íŒŒì‹±
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                paymentKey: params.get('paymentKey'),
                orderId: params.get('orderId'),
                amount: params.get('amount')
            };
        }

        // ìƒíƒœ í‘œì‹œ
        function showStatus(message, isLoading = true) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="status-icon">${isLoading ? 'â³' : 'âœ…'}</div>
                <h1>${isLoading ? 'ì²˜ë¦¬ ì¤‘...' : 'ì™„ë£Œ!'}</h1>
                <p>${message}</p>
                ${!isLoading ? '<button class="btn" onclick="goBack()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>' : ''}
            `;
        }

        // ì˜¤ë¥˜ í‘œì‹œ
        function showError(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="status-icon">âŒ</div>
                <h1>ì˜¤ë¥˜ ë°œìƒ</h1>
                <p>${message}</p>
                <button class="btn" onclick="goBack()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>
            `;
        }

        // ì„±ê³µ í‘œì‹œ
        function showSuccess(data) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="status-icon">âœ…</div>
                <h1>ê²°ì œ ì™„ë£Œ!</h1>
                <div class="order-info">
                    <h3>ì£¼ë¬¸ ì •ë³´</h3>
                    <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${data.orderId}</p>
                    <p><strong>ê²°ì œê¸ˆì•¡:</strong> ${parseInt(data.amount).toLocaleString()}ì›</p>
                    <p><strong>ê²°ì œë°©ë²•:</strong> í† ìŠ¤í˜ì´ë¨¼ì¸ </p>
                </div>
                <button class="btn" onclick="goBack()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>
            `;
        }

        // TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬ (ì•ˆì „í•œ ë²„ì „)
        async function processTLLPaymentSuccess() {
            try {
                const { paymentKey, orderId, amount } = getUrlParams();

                if (!paymentKey || !orderId || !amount) {
                    throw new Error('ê²°ì œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                console.log('ğŸ”„ TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬ ì‹œì‘:', { paymentKey, orderId, amount });
                showStatus('ê²°ì œ ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘...');

                // í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ìŠ¹ì¸ ì§ì ‘ í˜¸ì¶œ
                const confirmResponse = await fetch('/api/toss/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentKey, orderId, amount: parseInt(amount) })
                });

                if (!confirmResponse.ok) {
                    const errorData = await confirmResponse.json();
                    throw new Error(errorData.error || 'ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨');
                }

                const result = await confirmResponse.json();
                console.log('âœ… ê²°ì œ ìŠ¹ì¸ ì™„ë£Œ:', result);
                
                showSuccess({ paymentKey, orderId, amount });

            } catch (error) {
                console.error('âŒ TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                showError(`ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // TableLinkë¡œ ëŒì•„ê°€ê¸°
        function goBack() {
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.location.href = '/';
                    window.close();
                } else {
                    window.location.href = '/';
                }
            } catch (e) {
                window.location.href = '/';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        console.log('ğŸ“± ê²°ì œ ì„±ê³µ í˜ì´ì§€ ë¡œë“œ');
        document.addEventListener('DOMContentLoaded', () => {
            processTLLPaymentSuccess();
        });
    </script>
</body>
</html>
