<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì œ ì™„ë£Œ - TableLink</title>
    <link rel="stylesheet" href="/shared/css/toss-success.css">
</head>
<body>
    <div class="container">
        <div class="status-icon">â³</div>
        <h1>ê²°ì œ ì²˜ë¦¬ ì¤‘</h1>
        <p class="loading">ê²°ì œë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        <button class="btn" onclick="goBack()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <script src="/shared/utils/tossPaymentUtils.js"></script>
    <script src="/TLG/pages/store/pay/tossPayments.js"></script>
    <script>
        // URL íŒŒë¼ë¯¸í„° íŒŒì‹±
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                paymentKey: params.get('paymentKey'),
                orderId: params.get('orderId'),
                amount: params.get('amount')
            };
        }

        // ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        function goBack() {
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({
                        type: 'PAYMENT_SUCCESS_REDIRECT',
                        action: 'navigate',
                        url: '/'
                    }, '*');
                    window.close();
                } else {
                    window.location.href = '/';
                }
            } catch (error) {
                window.location.href = '/';
            }
        }

        // ìƒíƒœ í‘œì‹œ
        function showStatus(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="status-icon">â³</div>
                <h1>ì²˜ë¦¬ ì¤‘</h1>
                <p class="loading">${message}</p>
                <button class="btn" onclick="goBack()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>
            `;
        }

        // ì˜¤ë¥˜ í‘œì‹œ
        function showError(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="status-icon">âŒ</div>
                <h1>ì²˜ë¦¬ ì‹¤íŒ¨</h1>
                <p class="error">${message}</p>
                <button class="btn" onclick="goBack()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>
            `;
        }

        // ì„±ê³µ í‘œì‹œ
        function showSuccess(data) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="status-icon">âœ…</div>
                <h1>ê²°ì œ ì™„ë£Œ!</h1>
                <div class="order-info">
                    <h3>ê²°ì œ ì •ë³´</h3>
                    <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${data.orderId}</p>
                    <p><strong>ê²°ì œê¸ˆì•¡:</strong> â‚©${parseInt(data.amount).toLocaleString()}</p>
                </div>
                <button class="btn" onclick="goBack()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>
            `;
        }

        // TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬
        async function processTLLPaymentSuccess() {
            try {
                const params = getUrlParams();
                console.log('ğŸ”„ TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬ ì‹œì‘:', params);

                if (!params.paymentKey || !params.orderId || !params.amount) {
                    throw new Error('ê²°ì œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                showStatus('ê²°ì œ ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘');

                // í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ìŠ¹ì¸
                const confirmResult = await window.confirmTossPayment(
                    params.paymentKey,
                    params.orderId,
                    params.amount
                );

                if (!confirmResult.success) {
                    throw new Error(confirmResult.error || 'ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨');
                }

                console.log('âœ… TLL ê²°ì œ ìŠ¹ì¸ ì™„ë£Œ:', confirmResult);

                // ì„±ê³µ í‘œì‹œ
                showSuccess(params);

                // ì €ì¥ëœ ì£¼ë¬¸ ë°ì´í„° ì •ë¦¬
                sessionStorage.removeItem('tllPendingOrder');

                // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ë©”ì¸í™”ë©´ìœ¼ë¡œ ì´ë™
                setTimeout(() => {
                    goBack();
                }, 3000);

            } catch (error) {
                console.error('âŒ TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                showError(error.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', () => {
            console.log('ğŸ“± ê²°ì œ ì„±ê³µ í˜ì´ì§€ ë¡œë“œ');
            processTLLPaymentSuccess();
        });
    </script>
</body>
</html>