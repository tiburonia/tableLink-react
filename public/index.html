
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TableLink</title>
  
  <!-- ì¹´ì¹´ì˜¤ë§µ API -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2da5b80696f4403357706514d7c56b70&libraries=services"></script>
  
  <!-- ê¸€ë¡œë²Œ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="shared/css/favoriteStore.css" />
  <link rel="stylesheet" href="shared/css/globalBody.css" />
  <link rel="stylesheet" href="shared/css/renderLogin.css" />
  <link rel="stylesheet" href="TLG/styles/subMain.css" />
</head>

<body>
  <!-- ë©”ì¸ í™”ë©´ ë Œë”ë§ ì˜ì—­ -->
  <div id="main"></div>
  
  <!-- ì¥ë°”êµ¬ë‹ˆ ìœ„ì ¯ -->
  <div id="cartWidget"></div>

  <!-- í† ìŠ¤í˜ì´ë¨¼ì¸  SDK -->
  <script src="https://js.tosspayments.com/v1/payment-widget"></script>

  <!-- ì½”ì–´ ìœ í‹¸ë¦¬í‹° -->
  <script src="TLG/utils/storeCache.js"></script>
  <script src="TLG/utils/logOut.js"></script>
  <script src="TLG/utils/globalKeyboardEvents.js"></script>
  <script src="TLG/utils/regularLevelManager.js"></script>
  <script src="TLG/utils/creatCoupon.js"></script>
  <script src="TLG/utils/TLL.js"></script>

  <!-- ì¸ì¦ ê´€ë ¨ -->
  <script src="TLG/pages/auth/renderSignUp.js"></script>
  <script src="TLG/pages/auth/renderLogin.js"></script>

  <!-- ë©”ì¸ í˜ì´ì§€ ê´€ë ¨ -->
  <script src="TLG/pages/main/modules/mapPanelUI.js"></script>
  <script src="TLG/pages/main/modules/mapMarkerManager.js"></script>
  <script src="TLG/pages/main/renderMap.js"></script>
  <script src="TLG/pages/main/renderSearch.js"></script>
  <script src="TLG/pages/main/renderNotification.js"></script>
  <script src="TLG/pages/main/renderSubMain.js"></script>

  <!-- ë§ˆì´í˜ì´ì§€ ê´€ë ¨ -->
  <script src="TLG/pages/mypage/renderMyPage.js"></script>
  <script src="TLG/pages/mypage/renderMyAccount.js"></script>
  <script src="TLG/pages/store/order/renderAllOrderHTML.js"></script>

  <!-- ë§¤ì¥ ê´€ë ¨ -->
  <script src="TLG/pages/store/modules/renderStoreUI.js"></script>
  <script src="TLG/pages/store/modules/storePanelManager.js"></script>
  <script src="TLG/pages/store/modules/storeTabManager.js"></script>
  <script src="TLG/pages/store/modules/reviewManager.js"></script>
  <script src="TLG/pages/store/modules/tableInfoManager.js"></script>
  <script src="TLG/pages/store/renderStore.js"></script>
  <script src="TLG/pages/store/newStore/renderMenuHTML.js"></script>
  <script src="TLG/pages/store/newStore/renderReviewHTML.js"></script>
  <script src="TLG/pages/store/review/renderAllReview.js"></script>
  <script src="TLG/pages/store/favoriteStore/toggleFavoriteF.js"></script>
  <script src="TLG/pages/store/promotion/renderPromotionDetail.js"></script>

  <!-- ì£¼ë¬¸/ê²°ì œ ê´€ë ¨ -->
  <script src="TLG/pages/store/cart/saveCart.js"></script>
  <script src="TLG/pages/store/cart/renderCartWidget.js"></script>
  <script src="TLG/pages/store/cart/renderCart.js"></script>
  <script src="TLG/pages/store/renderOrderScreen.js"></script>
  <script src="TLG/pages/store/renderReservationScreen.js"></script>
  <script src="TLG/pages/store/pay/renderPay.js"></script>
  <script src="TLG/pages/store/pay/confirmPayF.js"></script>
  <script src="TLG/pages/store/pay/tossPayments.js"></script>
  <script src="TLG/pages/store/pay/paymentFailureUI.js"></script>

  <!-- ì•± ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    // ì „ì—­ ìƒíƒœ ì´ˆê¸°í™”
    window.currentPage = null;
    window.userInfo = null;
    
    // URL ë¼ìš°íŒ… ì²˜ë¦¬
    function handleRouting() {
      const urlParams = new URLSearchParams(window.location.search);
      const redirect = urlParams.get('redirect');
      const paymentKey = urlParams.get('paymentKey');
      const orderId = urlParams.get('orderId');
      const amount = urlParams.get('amount');

      // ê²°ì œ ì„±ê³µ ì²˜ë¦¬
      if (paymentKey && orderId && amount) {
        console.log('ğŸ’³ ê²°ì œ ì„±ê³µ - ì²˜ë¦¬ ì‹œì‘');
        handlePaymentSuccess(paymentKey, orderId, amount);
        return;
      }

      // ê²°ì œ í›„ ì§€ë„ ë¦¬ë‹¤ì´ë ‰íŠ¸
      if (redirect === 'map') {
        console.log('ğŸ’³ ê²°ì œ ì„±ê³µ í›„ ì§€ë„ í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
        window.history.replaceState({}, document.title, '/');
        renderMapSafely();
        return;
      }

      // ê¸°ë³¸ ë¡œê·¸ì¸ í™”ë©´
      renderLogin();
    }

    // ê²°ì œ ì„±ê³µ ì²˜ë¦¬ í•¨ìˆ˜
    async function handlePaymentSuccess(paymentKey, orderId, amount) {
      try {
        showPaymentProcessing();
        
        // ê²°ì œ ìŠ¹ì¸ API í˜¸ì¶œ
        const response = await fetch('/api/toss/success', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            paymentKey: paymentKey,
            orderId: orderId,
            amount: parseInt(amount)
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨');
        }

        const result = await response.json();
        showPaymentSuccess(result);

        // 3ì´ˆ í›„ ì§€ë„ í™”ë©´ìœ¼ë¡œ ì´ë™
        setTimeout(() => {
          window.history.replaceState({}, document.title, '/');
          renderMapSafely();
        }, 3000);

      } catch (error) {
        console.error('âŒ ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        showPaymentError(error);
      }
    }

    // ê²°ì œ ì²˜ë¦¬ ì¤‘ í™”ë©´
    function showPaymentProcessing() {
      document.getElementById('main').innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <div style="font-size: 64px; margin-bottom: 20px;">â³</div>
          <h1 style="font-size: 24px; margin-bottom: 16px; font-weight: 700;">ê²°ì œ ì²˜ë¦¬ ì¤‘</h1>
          <p style="font-size: 16px; opacity: 0.9; margin: 0;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
          <div style="margin-top: 30px;">
            <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          </div>
        </div>
        <style>
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      `;
    }

    // ê²°ì œ ì„±ê³µ í™”ë©´
    function showPaymentSuccess(result) {
      document.getElementById('main').innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
          <div style="font-size: 64px; margin-bottom: 20px;">âœ…</div>
          <h1 style="font-size: 24px; margin-bottom: 16px; font-weight: 700;">ê²°ì œ ì™„ë£Œ!</h1>
          <p style="font-size: 16px; opacity: 0.9; margin-bottom: 8px;">ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</p>
          <p style="font-size: 14px; opacity: 0.8; margin: 0;">ì ì‹œ í›„ ìë™ìœ¼ë¡œ ì§€ë„ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤</p>
        </div>
      `;
    }

    // ê²°ì œ ì˜¤ë¥˜ í™”ë©´
    function showPaymentError(error) {
      document.getElementById('main').innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
          <div style="font-size: 64px; margin-bottom: 20px;">âŒ</div>
          <h1 style="font-size: 24px; margin-bottom: 16px; font-weight: 700;">ê²°ì œ ì‹¤íŒ¨</h1>
          <p style="font-size: 16px; opacity: 0.9; margin-bottom: 16px;">${error.message || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'}</p>
          <button onclick="renderLogin()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      `;
    }

    // ì•ˆì „í•œ ì§€ë„ ë Œë”ë§
    function renderMapSafely() {
      if (typeof renderMap === 'function') {
        renderMap();
      } else {
        // renderMapì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ì¬ì‹œë„
        setTimeout(() => {
          if (typeof renderMap === 'function') {
            renderMap();
          } else {
            console.warn('âš ï¸ renderMap í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™');
            renderLogin();
          }
        }, 100);
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¼ìš°íŒ… ì²˜ë¦¬
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ“± TableLink SPA ì´ˆê¸°í™” ì‹œì‘');
      handleRouting();
    });

    // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì²˜ë¦¬
    window.addEventListener('popstate', (event) => {
      console.log('ğŸ”„ ë¸Œë¼ìš°ì € ë„¤ë¹„ê²Œì´ì…˜ ê°ì§€');
      handleRouting();
    });

    // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
    window.addEventListener('error', (event) => {
      console.error('âŒ ì „ì—­ ì—ëŸ¬:', event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('âŒ ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', event.reason);
    });
  </script>
</body>
</html>
