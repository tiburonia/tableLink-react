<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TableLink - ë©”ì¸</title>

  <!--ì¹´ì¹´ì˜¤ë§µ APIí‚¤-->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2da5b80696f4403357706514d7c56b70&libraries=services"></script>

  <!--ì „ì—­ CSS íŒŒì¼-->
  <link rel="stylesheet" href="shared/css/favoriteStore.css" />
  <link rel="stylesheet" href="shared/css/globalBody.css" />
  <link rel="stylesheet" href="shared/css/renderLogin.css" />
  <!--ì„œë¸Œë©”ì¸ CSS ì¶”ê°€-->
  <link rel="stylesheet" href="TLG/styles/subMain.css" />
</head>

<body>
  <!-- í™”ë©´ì„ ë Œë”ë§í•  ë©”ì¸ ì˜ì—­ -->
  <div id='main'></div>
  <!-- ì¥ë°”êµ¬ë‹ˆ ìœ„ì ¯ -->
  <div id='cartWidget'></div>

  <!--íšŒì›ê°€ì… í™”ë©´ ë Œë”ë§ í•¨ìˆ˜ (ë¡œê·¸ì¸ë³´ë‹¤ ë¨¼ì € ë¡œë“œ)-->
  <script src="TLG/pages/auth/renderSignUp.js"></script>
  <!--ë§ˆì´í˜ì´ì§€ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜ (ë¨¼ì € ë¡œë“œ)-->
  <script src="TLG/pages/mypage/renderMyPage.js"></script>
  <!--ë¡œê·¸ì¸ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/auth/renderLogin.js"></script>
  <!--ë¡œê·¸ì•„ì›ƒë¡œì§ í•¨ìˆ˜-->
  <script src="TLG/utils/logOut.js"></script>
  <!--QR ê²°ì œ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/utils/TLL.js"></script>
  <!--ë‚´ ê³„ì • í™”ë©´ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/mypage/renderMyAccount.js"></script>
  <!--ë§ˆì´í˜ì´ì§€ ì „ì²´ ë¦¬ë·° ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/store/order/renderAllOrderHTML.js"></script>
  <!--ì§€ë„ ëª¨ë“ˆë“¤-->
  <script src="TLG/pages/main/modules/mapPanelUI.js"></script>
  <script src="TLG/pages/main/modules/mapMarkerManager.js"></script>
  <!--ì§€ë„ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/main/renderMap.js"></script>
  <script src="TLG/pages/main/renderSearch.js"></script>
  <!--ì•Œë¦¼ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/main/renderNotification.js"></script>
  <!--ë§¤ì¥ ì¦ê²¨ì°¾ê¸° í† ê¸€ í•¨ìˆ˜-->
  <script src="TLG/pages/store/favoriteStore/toggleFavoriteF.js"></script>
  <!--ë©”ë‰´íƒ­ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/store/newStore/renderMenuHTML.js"></script>
  <!--ë¦¬ë·°íƒ­ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/store/newStore/renderReviewHTML.js"></script>
  <!--ì „ì²´ ë¦¬ë·° ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/store/review/renderAllReview.js"></script>
  <!--ë§¤ì¥ë Œë”ë§ ëª¨ë“ˆë“¤-->
  <script src="/TLG/pages/store/modules/renderStoreUI.js"></script>
  <script src="/TLG/pages/store/modules/storePanelManager.js"></script>
  <script src="/TLG/pages/store/modules/storeTabManager.js"></script>
  <script src="/TLG/pages/store/modules/reviewManager.js"></script>
  <script src="/TLG/pages/store/modules/tableInfoManager.js"></script>
  <!--ë§¤ì¥ë Œë”ë§ í•¨ìˆ˜ (ìš°ì„  ë¡œë”©)-->
  <script src="TLG/pages/store/renderStore.js"></script>
  <!--ê²°ì œ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/store/pay/renderPay.js"></script>
  <!--ì¿ í° ë°œê¸‰ í•¨ìˆ˜-->
  <script src="TLG/utils/creatCoupon.js"></script>
  <!--ê²°ì œ ì™„ë£Œ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/store/pay/renderPay.js"></script>
  <script src="TLG/pages/store/pay/confirmPayF.js"></script>
  <!--ê²°ì œ ì„±ê³µ/ì‹¤íŒ¨ UI ëª¨ë“ˆ (ë™ì  ë¡œë“œ)-->
  <!-- <script src="TLG/pages/store/pay/paymentSuccessUI.js"></script> -->
  <!--ì¥ë°”êµ¬ë‹ˆ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/store/cart/saveCart.js"></script>
  <!--ì¥ë°”êµ¬ë‹ˆ ìœ„ì ¯ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/store/cart/renderCartWidget.js"></script>
  <!--ì¥ë°”êµ¬ë‹ˆ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/store/cart/renderCart.js"></script>
  <!--ì£¼ë¬¸ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/store/renderOrderScreen.js"></script>
  <!--ì˜ˆì•½ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜-->
  <script src="TLG/pages/store/renderReservationScreen.js"></script>
  <!--ë§¤ì¥ ìºì‹œ ì‹œìŠ¤í…œ-->
  <script src="TLG/utils/storeCache.js"></script>
  <script src="/TLG/utils/globalKeyboardEvents.js"></script>
  <script src="/TLG/utils/regularLevelManager.js"></script>
  <!-- í˜œíƒ ìƒì„¸ë³´ê¸° ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
  <script src="../TLG/pages/store/promotion/renderPromotionDetail.js"></script>
  <!-- ì„œë¸Œ ë©”ì¸ í™”ë©´ ë Œë”ë§ í•¨ìˆ˜ ì¶”ê°€ -->
  <script src="TLG/pages/main/renderSubMain.js"></script>

  <script>
    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì‚¬ìš©ì ì •ë³´ ì¿ í‚¤ ë¡œë“œ
    function checkLoginStatus() {
      try {
        const userInfoCookie = document.cookie
          .split('; ')
          .find(row => row.startsWith('userInfo='));

        if (userInfoCookie) {
          const userInfoString = decodeURIComponent(userInfoCookie.split('=')[1]);
          window.userInfo = JSON.parse(userInfoString);
          console.log('âœ… ì¿ í‚¤ì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì™„ë£Œ:', window.userInfo);
          return true;
        } else {
          console.log('â„¹ï¸ ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹˜');
          return false;
        }
      } catch (error) {
        console.error('âŒ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        return false;
      }
    }

    // í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ì„±ê³µ ì²˜ë¦¬
    function handleTossPaymentSuccess() {
      const urlParams = new URLSearchParams(window.location.search);
      const paymentKey = urlParams.get('paymentKey');
      const orderId = urlParams.get('orderId');
      const amount = urlParams.get('amount');

      if (paymentKey && orderId && amount) {
        console.log('âœ… í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ì„±ê³µ ê°ì§€:', { paymentKey, orderId, amount });

        // confirmPay ëª¨ë“ˆ ë™ì  ë¡œë“œ ë° ì‹¤í–‰
        import('/TLG/pages/store/pay/confirmPayF.js')
          .then(() => {
            if (typeof window.confirmPay === 'function') {
              // URL íŒŒë¼ë¯¸í„°ë¥¼ ì´ìš©í•œ ê²°ì œ í™•ì¸ ì²˜ë¦¬
              const paymentResult = {
                paymentKey: paymentKey,
                orderId: orderId,
                method: 'TRANSFER'
              };

              // sessionStorageì—ì„œ ì£¼ë¬¸ ë°ì´í„° ë³µêµ¬
              const pendingData = sessionStorage.getItem('pendingOrderData');
              if (pendingData) {
                const orderInfo = JSON.parse(pendingData);
                window.confirmPay(paymentResult, orderInfo.finalTotal, orderInfo.selectedCouponId, orderInfo.couponDiscount);
              } else {
                console.error('âŒ ì €ì¥ëœ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                alert('ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                if (typeof renderMap === 'function') {
                  renderMap();
                }
              }
            }
          })
          .catch(error => {
            console.error('âŒ confirmPay ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            if (typeof renderMap === 'function') {
              renderMap();
            }
          });

        return true;
      }
      return false;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', () => {
      // í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ì„±ê³µ ì²˜ë¦¬ ìš°ì„  í™•ì¸
      if (handleTossPaymentSuccess()) {
        return; // ê²°ì œ ì„±ê³µ ì²˜ë¦¬ ì¤‘ì´ë©´ ë‹¤ë¥¸ ë¡œì§ ì‹¤í–‰ ì•ˆí•¨
      }

      // ì¼ë°˜ì ì¸ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
      if (checkLoginStatus()) {
        renderMap();
      } else {
        renderLogin();
      }
    });
  </script>
  <script>
    // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
    checkLoginStatus();

    // URL íŒŒë¼ë¯¸í„° í™•ì¸í•˜ì—¬ ë¦¬ë‹¤ì´ë ‰ì…˜ ì²˜ë¦¬
    const urlParams = new URLSearchParams(window.location.search);
    const redirect = urlParams.get('redirect');

    if (redirect && window.userInfo) {
      console.log('ğŸ”— URL íŒŒë¼ë¯¸í„° ë¦¬ë‹¤ì´ë ‰ì…˜:', redirect);

      // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±°
      window.history.replaceState({}, document.title, window.location.pathname);

      setTimeout(() => {
        if (redirect === 'map' && typeof renderMap === 'function') {
          renderMap();
        } else if (redirect === 'mypage' && typeof renderMyPage === 'function') {
          renderMyPage();
        }
      }, 500);
    }
  </script>
</body>

</html>