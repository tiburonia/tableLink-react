<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRP - ì£¼ë°© ì˜ìˆ˜ì¦ í”„ë¦°í„° | TableLink</title>
    <link rel="icon" href="/TableLink.png" type="image/png">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            overflow: hidden;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
        }

        .loading-logo {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .loading-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .loading-subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .url-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 12px;
            opacity: 0.7;
        }

        .error-container {
            text-align: center;
            padding: 40px;
            color: #ef4444;
        }

        .error-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .error-message {
            font-size: 16px;
            margin-bottom: 24px;
        }

        .error-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .error-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .retry-btn {
            background: #3b82f6;
            color: white;
        }

        .retry-btn:hover {
            background: #2563eb;
        }

        .back-btn {
            background: #6b7280;
            color: white;
        }

        .back-btn:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <div id="main">
        <div class="loading-container">
            <div class="loading-logo">ğŸ–¨ï¸</div>
            <div class="loading-title">KRP ì‹œìŠ¤í…œ</div>
            <div class="loading-subtitle">ì£¼ë°© ì˜ìˆ˜ì¦ í”„ë¦°í„° ì´ˆê¸°í™” ì¤‘...</div>
            <div class="loading-spinner"></div>
            <div class="url-info" id="urlInfo"></div>
        </div>
    </div>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- KRP ì‹œìŠ¤í…œ -->
    <script src="/krp/components/renderKRP.js"></script>

    <script>
        // URL ì •ë³´ í‘œì‹œ
        document.getElementById('urlInfo').textContent = window.location.href;

        // URLì—ì„œ storeId íŒŒë¼ë¯¸í„° ì¶”ì¶œ
        function getStoreIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('storeId');
            console.log('ğŸ” URLì—ì„œ ì¶”ì¶œí•œ ë§¤ì¥ ID:', storeId);
            return storeId;
        }

        // ì—ëŸ¬ í™”ë©´ ë Œë”ë§
        function renderError(message, showRetry = true) {
            const main = document.getElementById('main');
            main.innerHTML = `
                <div class="error-container">
                    <div class="error-title">âŒ KRP ì‹œìŠ¤í…œ ì˜¤ë¥˜</div>
                    <div class="error-message">${message}</div>
                    <div class="error-actions">
                        ${showRetry ? `
                            <button class="error-btn retry-btn" onclick="initKRP()">
                                ğŸ”„ ë‹¤ì‹œ ì‹œë„
                            </button>
                        ` : ''}
                        <button class="error-btn back-btn" onclick="goBack()">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                </div>
            `;
        }

        // ë’¤ë¡œê°€ê¸°
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/';
            }
        }

        // KRP ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        async function initKRP() {
            try {
                console.log('ğŸ–¨ï¸ KRP ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');

                // 1. storeId í™•ì¸
                const storeId = getStoreIdFromUrl();
                if (!storeId) {
                    throw new Error('ë§¤ì¥ IDê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. URLì— storeId íŒŒë¼ë¯¸í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                }

                console.log(`ğŸª ë§¤ì¥ ID í™•ì¸: ${storeId}`);

                // 2. renderKRP í•¨ìˆ˜ í™•ì¸
                if (typeof window.renderKRP !== 'function') {
                    throw new Error('KRP ë Œë”ë§ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                // 3. ë§¤ì¥ ID ìœ íš¨ì„± ê²€ì‚¬
                const storeIdNumber = parseInt(storeId);
                if (isNaN(storeIdNumber) || storeIdNumber <= 0) {
                    throw new Error(`ìœ íš¨í•˜ì§€ ì•Šì€ ë§¤ì¥ ID: ${storeId}`);
                }

                console.log('âœ… ì´ˆê¸° ê²€ì¦ ì™„ë£Œ, KRP ë Œë”ë§ ì‹œì‘...');

                // 4. KRP ë Œë”ë§ ì‹¤í–‰
                await window.renderKRP(storeIdNumber);

                console.log('âœ… KRP ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');

            } catch (error) {
                console.error('âŒ KRP ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);

                let errorMessage = error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì²˜ë¦¬
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
                }

                renderError(errorMessage);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ KRP í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');

            // ì§§ì€ ì§€ì—° í›„ ì´ˆê¸°í™” (ë¡œë”© í™”ë©´ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•¨)
            setTimeout(() => {
                initKRP();
            }, 1000);
        });

        // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
        window.addEventListener('error', (event) => {
            console.error('ğŸš¨ ì „ì—­ ì—ëŸ¬ ê°ì§€:', event.error);
            renderError('ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
        });

        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
        window.addEventListener('online', () => {
            console.log('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë³µêµ¬ë¨');
        });

        window.addEventListener('offline', () => {
            console.log('ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€');
        });
    </script>
</body>
</html>