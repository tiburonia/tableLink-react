
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„íšŒì› ê²°ì œ ì™„ë£Œ - TableLink</title>
    <link rel="stylesheet" href="/shared/css/toss-success.css">
</head>
<body>
    <div class="container">
        <div class="status-icon">â³</div>
        <h1>ê²°ì œ ì²˜ë¦¬ ì¤‘...</h1>
        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <script>
        // URL íŒŒë¼ë¯¸í„° íŒŒì‹± í•¨ìˆ˜
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                paymentKey: urlParams.get('paymentKey'),
                orderId: urlParams.get('orderId'),
                amount: urlParams.get('amount')
            };
        }

        // ìƒíƒœ í‘œì‹œ í•¨ìˆ˜
        function showStatus(message) {
            const container = document.querySelector('.container');
            if (container) {
                container.innerHTML = `
                    <div class="status-icon">â³</div>
                    <h1>${message}</h1>
                    <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                `;
            }
        }

        // ì„±ê³µ í‘œì‹œ í•¨ìˆ˜
        function showSuccess(data) {
            const { orderId, amount, guestName } = data;
            const container = document.querySelector('.container');
            if (container) {
                container.innerHTML = `
                    <div class="status-icon">âœ…</div>
                    <h1>ë¹„íšŒì› ê²°ì œ ì™„ë£Œ!</h1>
                    <div class="success-info">
                        <p><strong>ì£¼ë¬¸ì:</strong> ${guestName || 'ë¹„íšŒì›'}</p>
                        <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${orderId}</p>
                        <p><strong>ê²°ì œê¸ˆì•¡:</strong> â‚©${parseInt(amount).toLocaleString()}</p>
                    </div>
                    <div class="guest-notice">
                        <p>ğŸ’¡ ë¹„íšŒì›ìœ¼ë¡œ ì£¼ë¬¸í•˜ì…¨ìŠµë‹ˆë‹¤.</p>
                        <p>íšŒì› ê°€ì… ì‹œ í¬ì¸íŠ¸ ì ë¦½ ë° ë‹¤ì–‘í•œ í˜œíƒì„ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn primary" onclick="goBack()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>
                `;
            }
        }

        // ì—ëŸ¬ í‘œì‹œ í•¨ìˆ˜
        function showError(message) {
            const container = document.querySelector('.container');
            if (container) {
                container.innerHTML = `
                    <div class="status-icon">âŒ</div>
                    <h1>ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨</h1>
                    <div class="error-info">
                        <p>${message}</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn primary" onclick="goBack()">TableLinkë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>
                `;
            }
        }

        // ë¹„íšŒì› TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬
        async function processGuestTLLPaymentSuccess() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const paymentKey = urlParams.get('paymentKey');
                const orderId = urlParams.get('orderId');
                const amount = urlParams.get('amount');

                if (!paymentKey || !orderId || !amount) {
                    throw new Error('ê²°ì œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                console.log('ğŸ”„ ë¹„íšŒì› TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬ ì‹œì‘:', { paymentKey, orderId, amount });
                showStatus('ë¹„íšŒì› ê²°ì œ ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘...');

                // ë¹„íšŒì› ê²°ì œ ìŠ¹ì¸ API í˜¸ì¶œ
                const confirmResponse = await fetch('/api/toss/confirm-guest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentKey, orderId, amount: parseInt(amount) })
                });

                if (!confirmResponse.ok) {
                    const errorData = await confirmResponse.json();
                    throw new Error(errorData.error || 'ë¹„íšŒì› ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨');
                }

                const result = await confirmResponse.json();
                console.log('âœ… ë¹„íšŒì› ê²°ì œ ìŠ¹ì¸ ì™„ë£Œ:', result);

                // ì„±ê³µ í™”ë©´ í‘œì‹œ
                showSuccess({ 
                    paymentKey, 
                    orderId, 
                    amount,
                    guestName: result.data?.guestName || 'ë¹„íšŒì›'
                });

            } catch (error) {
                console.error('âŒ ë¹„íšŒì› TLL ê²°ì œ ì„±ê³µ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                showError(`ë¹„íšŒì› ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // TableLinkë¡œ ëŒì•„ê°€ê¸°
        function goBack() {
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.location.href = '/';
                    window.close();
                } else {
                    window.location.href = '/';
                }
            } catch (e) {
                window.location.href = '/';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        console.log('ğŸ“± ë¹„íšŒì› ê²°ì œ ì„±ê³µ í˜ì´ì§€ ë¡œë“œ');
        document.addEventListener('DOMContentLoaded', () => {
            processGuestTLLPaymentSuccess();
        });
    </script>

    <style>
        .guest-notice {
            background: linear-gradient(135deg, #fff7ed, #ffedd5);
            border: 2px solid #fb923c;
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            text-align: center;
        }

        .guest-notice p {
            margin: 4px 0;
            color: #9a3412;
            font-size: 14px;
            font-weight: 500;
        }

        .guest-notice p:first-child {
            font-weight: 700;
            font-size: 15px;
        }
    </style>
</body>
</html>
