ğŸ”¹ 1ï¸âƒ£ ì „ì²´ êµ¬ì¡° ìš”ì•½
ğŸ¯ ëª©ì 

tossController.confirm ì—ì„œ

paymentService.confirmTossPayment() ì‹¤í–‰

âœ… ê²°ì œ ì™„ë£Œ ì‹œ â†’ regularService.handleRegularAfterPayment() ì‹¤í–‰

ğŸ”¹ 2ï¸âƒ£ ì»¨íŠ¸ë¡¤ëŸ¬ ë ˆë²¨ ìˆ˜ì • ê³„íš (tossController.confirm)
// tossController.js
async function confirm(req, res) {
  try {
    const { paymentKey, orderId, amount, userId, storeId } = req.body;

    // 1ï¸âƒ£ ê¸°ì¡´ ê²°ì œ ê²€ì¦ ë° í™•ì • ì²˜ë¦¬
    const paymentResult = await paymentService.confirmTossPayment({
      paymentKey,
      orderId,
      amount,
    });

    if (!paymentResult.success) {
      return res.status(400).json({ success: false, message: "ê²°ì œ ì‹¤íŒ¨" });
    }

    // 2ï¸âƒ£ âœ… ë‹¨ê³¨ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
    await regularService.handleRegularAfterPayment({ storeId, userId });

    return res.status(200).json({ success: true, paymentResult });
  } catch (err) {
    console.error("âŒ tossController.confirm ì—ëŸ¬:", err);
    return res.status(500).json({ success: false, message: err.message });
  }
}

ğŸ”¹ 3ï¸âƒ£ ì„œë¹„ìŠ¤ ë ˆë²¨ ì‹ ì„¤ ê³„íš (regularService.handleRegularAfterPayment)
// regularService.js
async function handleRegularAfterPayment({ storeId, userId }) {
  // 1ï¸âƒ£ ê¸°ì¡´ ë‹¨ê³¨ ê¸°ë¡ ì¡°íšŒ
  const existingRegular = await regularRepository.findRegularByStoreAndUser(storeId, userId);

  if (existingRegular) {
    // 2ï¸âƒ£ ê¸°ì¡´ ë‹¨ê³¨ì´ë©´ ì—…ë°ì´íŠ¸ (ë°©ë¬¸ìˆ˜, ëˆ„ì ê²°ì œê¸ˆì•¡ ë“±)
    await regularRepository.updateRegularStats(storeId, userId);

    // 3ï¸âƒ£ ë“±ê¸‰ ì¡°ê±´ ì¶©ì¡± ì—¬ë¶€ í™•ì¸
    const currentLevel = existingRegular.level;
    const nextLevel = await regularRepository.findNextLevel(storeId, currentLevel);

    const eligible = await regularRepository.checkLevelCondition(nextLevel, existingRegular);
    if (eligible) {
      // 4ï¸âƒ£ ìƒˆ ë ˆë²¨ ë ˆì½”ë“œ ì¶”ê°€ & ê¸°ì¡´ ë ˆì½”ë“œ ìƒíƒœ ë³€ê²½
      await regularRepository.promoteRegularLevel({
        storeId,
        userId,
        nextLevel,
      });
    }
  } else {
    // 5ï¸âƒ£ ë‹¨ê³¨ ê¸°ë¡ì´ ì—†ìœ¼ë©´ â†’ ìµœí•˜ìœ„ ë“±ê¸‰ìœ¼ë¡œ ì‹ ê·œ ìƒì„±
    const lowestLevel = await regularRepository.findLowestLevel(storeId);
    await regularRepository.createRegular({
      storeId,
      userId,
      level: lowestLevel.grade,
    });
  }
}

ğŸ”¹ 4ï¸âƒ£ ë¦¬í¬ì§€í† ë¦¬ ë ˆë²¨ ì„¤ê³„ (regularRepository)
// regularRepository.js

async function findRegularByStoreAndUser(storeId, userId) {
  return await db.query(`
    SELECT * FROM store_regular_customers 
    WHERE store_id = $1 AND user_id = $2 
    AND is_processing_level = true
  `, [storeId, userId]);
}

async function updateRegularStats(storeId, userId) {
  await db.query(`
    UPDATE store_regular_customers
    SET visit_count = visit_count + 1,
        total_spent = total_spent + (SELECT total_price FROM orders WHERE store_id=$1 AND user_id=$2 ORDER BY created_at DESC LIMIT 1),
        updated_at = NOW()
    WHERE store_id=$1 AND user_id=$2
  `, [storeId, userId]);
}

async function findNextLevel(storeId, currentGrade) {
  return await db.query(`
    SELECT * FROM store_regular_levels
    WHERE store_id = $1 AND grade > $2
    ORDER BY grade ASC LIMIT 1
  `, [storeId, currentGrade]);
}

async function checkLevelCondition(level, regular) {
  if (!level) return false;
  const { min_visit, min_spent } = level;
  return (regular.visit_count >= min_visit && regular.total_spent >= min_spent);
}

async function promoteRegularLevel({ storeId, userId, nextLevel }) {
  // ê¸°ì¡´ ë ˆì½”ë“œ ì²˜ë¦¬ì¤‘ë‹¨
  await db.query(`
    UPDATE store_regular_customers
    SET is_processing_level = false
    WHERE store_id=$1 AND user_id=$2 AND is_processing_level=true
  `, [storeId, userId]);

  // ìƒˆ ë“±ê¸‰ìœ¼ë¡œ ì¶”ê°€
  await db.query(`
    INSERT INTO store_regular_customers (store_id, user_id, level, is_processing_level, created_at)
    VALUES ($1, $2, $3, true, NOW())
  `, [storeId, userId, nextLevel.grade]);
}

async function findLowestLevel(storeId) {
  return await db.query(`
    SELECT * FROM store_regular_levels
    WHERE store_id = $1
    ORDER BY grade ASC LIMIT 1
  `, [storeId]);
}

async function createRegular({ storeId, userId, level }) {
  await db.query(`
    INSERT INTO store_regular_customers (store_id, user_id, level, visit_count, total_spent, is_processing_level)
    VALUES ($1, $2, $3, 1, 0, true)
  `, [storeId, userId, level]);
}

ğŸ”¹ 5ï¸âƒ£ ë°ì´í„° íë¦„ ìš”ì•½
[1] tossController.confirm
      â†“
[2] paymentService.confirmTossPayment()
      â†“ (ì„±ê³µ ì‹œ)
[3] regularService.handleRegularAfterPayment()
      â”œâ”€â”€ findRegularByStoreAndUser()
      â”œâ”€â”€ updateRegularStats() or createRegular()
      â”œâ”€â”€ findNextLevel()
      â”œâ”€â”€ checkLevelCondition()
      â””â”€â”€ promoteRegularLevel()

ğŸ”¹ 6ï¸âƒ£ DB êµ¬ì¡° ì „ì œ (ìš”ì•½)
store_regular_customers
í•„ë“œ	ì„¤ëª…
id	PK
store_id	ë§¤ì¥
user_id	ìœ ì €
level	í˜„ì¬ ë“±ê¸‰
visit_count	ë°©ë¬¸ íšŸìˆ˜
total_spent	ëˆ„ì  ê¸ˆì•¡
is_processing_level	í˜„ì¬ í™œì„± ë“±ê¸‰ ì—¬ë¶€
created_at	ìƒì„±ì¼
store_regular_levels
í•„ë“œ	ì„¤ëª…
id	PK
store_id	ë§¤ì¥
grade	ë“±ê¸‰ ë ˆë²¨
name	ë“±ê¸‰ëª…
min_visit	í•„ìš” ë°©ë¬¸ ìˆ˜
min_spent	í•„ìš” ê²°ì œ ê¸ˆì•¡
benefits	í˜œíƒ (JSONB ê°€ëŠ¥)
âœ… ìµœì¢… ì •ë¦¬
ìˆ˜ì • ìœ„ì¹˜	ë³€ê²½ ë‚´ìš©	ì„¤ëª…
tossController.confirm	regularService.handleRegularAfterPayment í˜¸ì¶œ ì¶”ê°€	ê²°ì œ ì™„ë£Œ í›„ ë‹¨ê³¨ ìë™ ì²˜ë¦¬
regularService	ì‹ ê·œ ì„œë¹„ìŠ¤ í•¨ìˆ˜ ìƒì„±	store_regular_customers ê´€ë¦¬
regularRepository	ì¡°íšŒÂ·ì—…ë°ì´íŠ¸Â·ìŠ¹ê¸‰ í•¨ìˆ˜ ì¶”ê°€	DB ì¡°ì‘ ì „ë‹´
ê²°ê³¼	ë‹¨ê³¨ ìë™ ê°±ì‹ /ìŠ¹ê¸‰ ì‹œìŠ¤í…œ ì™„ì„±	ê²°ì œ ê¸°ë°˜ ë¦¬í…ì…˜ ë£¨í”„ ì™„ì„±