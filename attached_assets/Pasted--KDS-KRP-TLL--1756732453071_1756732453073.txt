목표

테이블 좌석에 앉아 있는 동안의 전 과정을 하나의 세션으로 관리

임시(미확정) ↔ 확정을 분리해 안전하게 다루고,
KDS/KRP 예외(취소, 누락, 재출력)와 TLL(앱/QR) 주문을 동일 세션 안에서 일관 처리

부분결제/복합결제/환불을 지원하고, 정산·감사 추적까지 깔끔하게

핵심 개념(엔티티, 상태, 불변식)

표기된 용어는 “의미”만 제시한 거고, 실제 명칭/코드는 네 쪽에서 정하면 돼.

1) 세션(테이블 체류 단위)

의미: 손님 착석 → 결제/퇴석까지의 시간 범위 컨테이너

대표 상태(코드 값은 자유):

열림, 주문진행, 주방처리, 결제중, 닫힘, 시간초과, 취소

불변식:

세션 합계 = (확정 주문 합계 − 조정액)

결제누계 − 환불누계 = 세션 결제완료 금액

닫힘 상태에서는 추가 확정/결제 불가

2) 주문 배치(세션 내 “확정” 묶음)

의미: “확정 버튼”을 눌러 DB에 고정되는 한 번치 주문

상태 예시: 임시(클라이언트/세션 버퍼), 확정, 주방처리, 준비완료, 무효/취소

특징: 세션 동안 여러 번 생길 수 있음(첫 주문, 추가 주문…).

3) 주문 항목(메뉴 라인)

의미: 메뉴 1종의 수량/가격/옵션 단위

상태 예시: 대기, 조리중, 준비완료, 서빙완료, 취소

변경 원칙: “변경 = 기존 항목 취소 + 신규 항목 생성” (가역성·감사추적 용이)

4) 결제(세션 또는 주문 단위로 귀속)

의미: 한 번의 결제 시도/성공/환불 단위(다건 가능)

상태 예시: 대기, 승인, 부분승인, 환불, 무효

복합결제(현금+카드), 분할결제(여럿이 나눔), 부분환불 지원

5) 조정(할인/서비스/오류보정)

의미: 금액을 증가/감소시키는 별도 엔티티(세션 또는 주문/항목에 귀속)

타입 예시: 정률/정액 할인, 쿠폰, 서비스/컴프, 금액보정

합계에 반영되지만, 원가/매출 리포트에서 이유가 분리 추적돼야 함

6) 주방 티켓(KDS용 단위)

의미: 확정된 주문 배치를 조리 단위로 쪼개어 발행한 처리 티켓

상태 예시: 대기, 조리중, 완료

항목별 타이밍(조리 시작/완료) 기록

7) 출력 작업(KRP)

의미: 특정 티켓/주문서에 대해 프린터 출력 시도 로그

상태 예시: 성공, 실패(재시도 카운트 포함), 수동재출력

중복 방지용 해시/서명 혹은 idempotency 키로 중복 출력 판정

8) 이벤트/감사 로그

의미: 모든 중요 동작의 Append-only 기록(누가/언제/무엇을/전후 값)

필수: 생성/수정/취소/환불/재출력/락획득/충돌해결 등

전형 흐름(UX + 서버)
A. 임시 → 확정(주문)

테이블 진입 시 임시 버퍼 활성(클라이언트/세션 스토리지/서버 임시 영역 등)

메뉴 추가/수정/삭제는 전부 임시에만 반영, UI에 “임시” 배지/배경 표시

확정 버튼 클릭 시:

서버 트랜잭션 시작

임시 내용을 “주문 배치 + 항목”으로 영구 반영

주방 티켓 생성, 아웃박스/이벤트 발행(KDS, KRP)

트랜잭션 커밋, 임시 버퍼 비우기

확정 없이 이탈 시: 임시 폐기(나가기 경고 모달)

B. 추가 주문

세션이 열린 동안 동일 절차 반복(임시→확정 주기).

배치별로 KDS/프린터가 독립적으로 움직일 수 있게 분리되어야 함.

C. 결제(합산/분할/복합)

결제 진입 시 세션 내 “미지불 확정 배치” 합계 계산

결제 방식 선택 → 단건 혹은 복수 결제 생성(현금/카드/간편/포인트 등)

외부 결제(PG/VAN) 응답 핸들링:

승인키/트랜잭션키 저장(공급자별 원시키 + 내부 매핑)

이벤트 발행: KDS 화면 “결제진행/완료” 알림(필요 시)

합계가 0이 되면 세션 닫힘, 테이블 해제

부분결제/분할결제의 경우: 세션 유지, 잔액 표시

D. 환불/부분취소

원 결제 레코드 참조하여 부분 금액 환불 가능

환불 전, 이미 조리·서빙된 항목이라면 조정/컴프로 처리 정책도 허용

환불/보정은 반드시 이벤트/감사 로그에 남김

KDS/KRP 예외 설계(필수)
KDS

취소: 항목/배치 단위 취소 가능 → 상태 “취소” 기록 + KRP 취소전표 발행 이벤트

수량 변경: 기존 항목 취소 + 신규 항목 1건 생성(가역성 유지)

조리 vs 서빙: “조리완료”와 “서빙완료”는 별도 상태로 분리(누락 추적)

타이머/긴급도: 티켓에 경과/우선순위 메타 포함(시각적 강조)

KRP(주문서 출력)

출력 시도마다 출력 작업 로그 생성(성공/실패/재시도)

실패 시 프론트/관리자 알림 + 수동 재출력 경로

중복 방지: 동일 페이로드에 대한 해시/아이디empotency 토큰 검사

동시성/무결성

동일 테이블/세션 편집 락(점유자/만료시간 표시) + 자동 타임아웃

낙관적 잠금: 버전/수정시각 비교로 경합 시 충돌 경고 및 머지 UI

원자성:

확정(주문생성) ↔ KDS/프린트 이벤트는 아웃박스 패턴으로 최소 1회 전달 보장

결제 승인 ↔ 내부 반영도 트랜잭션 경계 명확히

TLL(앱/QR) 통합 규칙

외부에서 들어온 주문은 세션에 자동 귀속(테이블/매핑키 기반)

POS 화면에 원천 배지(앱/QR) 표시, 기본 수정 불가

합산 결제 가능: 미지불인 TLL + POS 확정분을 동시에 결제
(이미 사전결제된 TLL은 결제누계에 포함하되 미지불 합계에서는 제외)

만료/장애/오프라인

세션 유휴시간 초과 시 시간초과 상태로 자동 전이 → 임시/대기 작업 정리

POS 오프라인: 로컬 큐에 확정/결제 시도 저장 → 재연결 시 순차 동기화
(중복 생성 방지용 클라이언트 idempotency 키 필수)

프린터/네트워크 장애 시 재시도 정책 + 관리자 수동 복구 절차

검증 규칙(대표)

세션 닫힘 이후엔 어떠한 확정/결제/조정도 불가(관리자 권한 제외, 로그 필수)

합계 검증:

(확정 항목 총액 − 조정 총액) − (승인 결제 총액 − 환불 총액) = 미수금

닫힘 시 미수금은 0

취소/환불은 항상 감사 로그 남김(행위자/사유/금액/관계)

이벤트/통신

내부 이벤트(예: “주문확정됨”, “항목취소됨”, “티켓출력요청”, “결제승인됨”, “환불됨”)를 도메인 이벤트로 표준화

KDS/KRP는 이벤트 구독(웹소켓/스트림) + 필요한 경우 REST 후속 조회

외부 결제(PG/VAN)는 승인/취소/정산 각각에 대해 어댑터로 캡슐화

UI 신호(프론트 공통 원칙)

“임시” 단계: 상단 배너/아이콘으로 저장 전임을 명시, 이탈 시 경고

“원천 배지”: POS 입력 vs 앱/QR 유입 시 아이콘/색상 구분

“결제 패널”: 합산/분할/복합/잔액/영수증 상태가 한눈에

“예외 안내”: 취소/재출력/프린터 실패 시 즉시 토스트 + 로그로 점프

테스트/수용 기준(샘플)

임시 → 확정 → KDS/출력 이벤트 최소 1회 전달 보장

확정 없이 이탈 시 데이터 영구 반영 없음

동일 세션 내 N번 추가 주문 + M건 결제(복합/분할) 후 합계 정합

항목 수량 변경 = “취소 + 신규”로 이력 재구성 가능

프린터 실패 후 재출력 시 중복 전표 방지 확인

TLL 미지불 + POS 확정 합산 결제 정상, TLL 사전결제는 잔액 계산에서 제외

동시 편집 충돌 시 경고 및 안전한 병합/롤백

적용 팁

위 설계는 의미/제약/흐름만 정의했어.

네 프로젝트의 테이블/컬럼/변수명은 그대로 쓰고,
각 개념을 네 명명체계에 의미적으로 매핑만 하면 된다.

구현 순서는:

임시버퍼/확정 경계 + 아웃박스 이벤트

세션 합산 결제(복합/분할 기본형)

KDS 취소·변경 = “취소+신규” 정착

KRP 출력 로그/idempotency

환불/조정, 감사로그, 오프라인 큐