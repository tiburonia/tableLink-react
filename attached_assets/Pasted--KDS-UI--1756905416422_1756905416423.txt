🎯 설계 요점

KDS UI → "최종적으로 주방이 조리해야 할 주문"만 단순히 보여줌.

취소/수정 이력은 굳이 노출하지 않음.

단, 조리 중 취소된 건은 몇 초간 경고 표시 후 자동 숨김.

DB 저장 전략

POS 주문: 단순 입력 실수(수량/메뉴 수정)는 UPDATE로 원본 덮어쓰기.

TLL 주문: 불변 원칙. 원본 check_items는 CANCELED 처리, 새 아이템 INSERT.

이렇게 하면 POS는 실무 편의성, TLL은 데이터 추적/환불 대비를 둘 다 만족.

KDS 이벤트 관리

내부적으로는 kds_events 테이블에 로그를 남기되, POS 주문은 필수 아님.

TLL 주문은 반드시 이벤트 기록(ITEM_CREATED, ITEM_CANCELED, ITEM_MODIFIED 등).

🗄️ DB 구조 (최종안)
check_items (주문 아이템)
ALTER TABLE check_items
  ADD COLUMN kds_status TEXT DEFAULT 'PENDING',  
  -- PENDING / COOKING / DONE / SERVED / CANCELED

  ADD COLUMN station_id INT,                     
  ADD COLUMN fired_at TIMESTAMP,
  ADD COLUMN started_at TIMESTAMP,
  ADD COLUMN done_at TIMESTAMP,
  ADD COLUMN canceled_at TIMESTAMP,
  ADD COLUMN cancel_reason TEXT,
  ADD COLUMN source_system TEXT;  -- 'POS' | 'TLL'

kds_events (옵션: TLL 중심 이벤트 로그)
CREATE TABLE kds_events (
  id BIGSERIAL PRIMARY KEY,
  store_id INT NOT NULL,
  ticket_item_id INT,
  event_type TEXT NOT NULL,     -- ITEM_CREATED / ITEM_STARTED / ITEM_DONE / ITEM_CANCELED / ITEM_MODIFIED
  payload JSONB DEFAULT '{}',
  actor_type TEXT,              -- 'USER'/'SYSTEM'/'POS'/'TLL'
  actor_id TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

🔄 처리 로직
1. 신규 주문

POS: check_items INSERT

TLL: check_items INSERT + kds_events: ITEM_CREATED

2. 주문 수정

POS: 그냥 UPDATE check_items (수량/메뉴 변경)

TLL:

기존 아이템 status=CANCELED

새 아이템 INSERT

kds_events: ITEM_MODIFIED 기록

3. 주문 취소

POS: DB DELETE 또는 UPDATE status=CANCELED (운영 정책에 맞춤)

TLL: status=CANCELED, canceled_at 기록, kds_events: ITEM_CANCELED 남김

4. 상태 변경 (주방 조작)

PENDING → COOKING → DONE → SERVED

각 단계마다 check_items.kds_status 업데이트

(TLL 주문은 kds_events에도 기록)

📺 KDS UI 노출 규칙

check_items.kds_status IN ('PENDING','COOKING','DONE') 만 노출

취소/수정된 아이템은 기본적으로 숨김

단, COOKING 상태에서 취소된 건은

UI에 빨간색 카드+“취소됨” 표시를 3~5초간 보여주고 자동 제거

🧩 시스템 흐름 비교
구분	POS 주문	TLL 주문
저장 방식	UPDATE(덮어쓰기) 허용	불변: CANCEL+INSERT
취소/수정 이력	DB에 남기지 않아도 됨	반드시 이벤트 로그 보존
KDS 노출	최종 상태만 표시	최종 상태만 표시 (이력은 DB에만)
UI 표시	수정 흔적 없음	조리 중 취소 시 잠깐 경고 표시
✅ 정리

POS = 실무 편의성 → 덮어쓰기/간단한 DB 구조

TLL = 고객/데이터 중심 → 불변 구조 + 이력 보존

KDS UI = 두 소스를 합쳐도 “최종 조리해야 할 것만” 보여주기 → 단순/명확

취소/수정 = UI엔 최소한만 노출, DB엔 소스에 맞게 처리