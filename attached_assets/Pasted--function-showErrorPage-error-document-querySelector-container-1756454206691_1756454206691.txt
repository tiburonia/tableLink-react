âœ…
ê²°ì œ ì²˜ë¦¬ ì¤‘
ê²°ì œë¥¼ í™•ì¸í•˜ê³  ìžˆìŠµë‹ˆë‹¤

`; } function showErrorPage(error) { document.querySelector('.container').innerHTML = `
âŒ
ê²°ì œ ì‹¤íŒ¨
ì˜¤ë¥˜ ë°œìƒ
${error.message || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}

TableLinkë¡œ ëŒì•„ê°€ê¸°
`; } async function processPayment() { try { // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê²°ì œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° const urlParams = new URLSearchParams(window.location.search); const paymentKey = urlParams.get('paymentKey'); const orderId = urlParams.get('orderId'); const amount = urlParams.get('amount'); console.log('ðŸ“‹ URL íŒŒë¼ë¯¸í„°:', { paymentKey, orderId, amount }); console.log('ðŸ”— ì „ì²´ URL:', window.location.href); if (!paymentKey || !orderId || !amount) { console.error('âŒ ëˆ„ë½ëœ íŒŒë¼ë¯¸í„°:', { paymentKey, orderId, amount }); throw new Error('ê²°ì œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); } // ê²°ì œ ìŠ¹ì¸ API í˜¸ì¶œ console.log('ðŸ’³ í† ìŠ¤íŽ˜ì´ë¨¼ì¸  ê²°ì œ ìŠ¹ì¸ ìš”ì²­ ì‹œìž‘'); const approvalResponse = await fetch('/api/toss/success', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ paymentKey: paymentKey, orderId: orderId, amount: parseInt(amount) }) }); if (!approvalResponse.ok) { const errorData = await approvalResponse.json(); throw new Error(errorData.error || 'ê²°ì œ ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); } const approvalResult = await approvalResponse.json(); console.log('âœ… í† ìŠ¤íŽ˜ì´ë¨¼ì¸  ê²°ì œ ìŠ¹ì¸ ì™„ë£Œ:', approvalResult); // ì €ìž¥ëœ ì£¼ë¬¸ ë°ì´í„° í™•ì¸ const savedOrderData = JSON.parse(sessionStorage.getItem('pendingOrderData') || '{}'); console.log('ðŸ’¾ ì €ìž¥ëœ ì£¼ë¬¸ ë°ì´í„°:', savedOrderData); let orderResult = null; if (savedOrderData && savedOrderData.userId) { console.log('ðŸ”„ ì£¼ë¬¸ ìƒì„± API í˜¸ì¶œ ì‹œìž‘'); // í…Œì´ë¸” ë²ˆí˜¸ ì •ê·œí™” const normalizedTableNumber = parseInt(savedOrderData.tableNumber) || parseInt(savedOrderData.orderData?.tableNum) || parseInt(savedOrderData.orderData?.table) || savedOrderData.tableNumber; // ê¸°ì¡´ ì €ìž¥ëœ ì£¼ë¬¸ ë°ì´í„°ì— ê²°ì œ ì •ë³´ ì¶”ê°€ const finalOrderData = { ...savedOrderData, tableNumber: normalizedTableNumber, pgPaymentKey: paymentKey, pgOrderId: orderId, pgPaymentMethod: 'CARD' }; // ì£¼ë¬¸ ìƒì„± API í˜¸ì¶œ console.log('ðŸ“ ì£¼ë¬¸ ìƒì„± ìš”ì²­ ë°ì´í„°:', finalOrderData); const orderResponse = await fetch('/api/orders/pay', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(finalOrderData) }); if (orderResponse.ok) { orderResult = await orderResponse.json(); console.log('âœ… ì£¼ë¬¸ ìƒì„± ì™„ë£Œ:', orderResult); } else { const errorData = await orderResponse.json(); console.error('âŒ ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨:', { status: orderResponse.status, statusText: orderResponse.statusText, error: errorData, requestData: finalOrderData }); } // ì €ìž¥ëœ ì£¼ë¬¸ ë°ì´í„° ì‚­ì œ sessionStorage.removeItem('pendingOrderData'); } else { console.warn('âš ï¸ ì €ìž¥ëœ ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê²°ì œë§Œ ìŠ¹ì¸ë¨'); } // ì„±ê³µ íŽ˜ì´ì§€ í‘œì‹œ showSuccessPage(paymentKey, orderId, amount, orderResult); } catch (error) { console.error('âŒ ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨:', error); showErrorPage(error); } } function goBack() { // í˜„ìž¬ ì°½ì—ì„œ ì•ˆì „í•˜ê²Œ ì§€ë„ í™”ë©´ìœ¼ë¡œ ì´ë™ try { window.location.href = '/?redirect=map'; } catch (error) { console.error('goBack ì‹¤íŒ¨:', error); window.location.replace('/'); } } // íŽ˜ì´ì§€ ë¡œë“œ ì‹œ ê²°ì œ ì²˜ë¦¬ window.addEventListener('load', () => { setTimeout(processPayment, 500); });