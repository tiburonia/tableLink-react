router.post('/orders/confirm', async (req, res) => {
  const client = await pool.connect();

  try {
    const {
      storeId,
      tableNumber,
      items,
      totalAmount,
      orderType,
      isGuestOrder = true,
      mergeWithExisting = false,
      existingOrderId = null
    } = req.body;

    console.log(`ğŸ›’ POS ì£¼ë¬¸ í™•ì •: ë§¤ì¥ ${storeId}, í…Œì´ë¸” ${tableNumber}, ${items.length}ê°œ ì•„ì´í…œ (ë¹„íšŒì›: ${isGuestOrder})`);

    if (!storeId || !tableNumber || !items || !Array.isArray(items) || items.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤'
      });
    }

    await client.query('BEGIN');

    // 1. TLL ì—°ë™ ì—¬ë¶€ì— ë”°ë¥¸ ì£¼ë¬¸ ì²˜ë¦¬
    let orderId;

    if (mergeWithExisting && existingOrderId) {
      // TLL ì—°ë™: ê¸°ì¡´ ì£¼ë¬¸ì— ì¶”ê°€
      console.log(`ğŸ”— TLL ì—°ë™ ì£¼ë¬¸: ê¸°ì¡´ ì£¼ë¬¸ ${existingOrderId}ì— POS ì£¼ë¬¸ ì¶”ê°€`);

      // ê¸°ì¡´ ì£¼ë¬¸ ì¡´ì¬ ë° is_mixed ìƒíƒœ í™•ì¸
      const existingOrderCheck = await client.query(`
        SELECT id, is_mixed, session_status, source, total_price
        FROM orders
        WHERE id = $1 AND session_status = 'OPEN'
      `, [existingOrderId]);

      if (existingOrderCheck.rows.length === 0) {
        return res.status(404).json({
          success: false,
          error: 'ì—°ë™í•  ê¸°ì¡´ ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
        });
      }

      const existingOrder = existingOrderCheck.rows[0];

      if (!existingOrder.is_mixed) {
        return res.status(400).json({
          success: false,
          error: 'í•´ë‹¹ ì£¼ë¬¸ì€ ì—°ë™ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'
        });
      }

      if (existingOrder.source !== 'TLL') {
        return res.status(400).json({
          success: false,
          error: 'TLL ì£¼ë¬¸ì´ ì•„ë‹™ë‹ˆë‹¤'
        });
      }

      orderId = existingOrderId;

      // ê¸°ì¡´ ì£¼ë¬¸ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
      await client.query(`
        UPDATE orders
        SET total_price = COALESCE(total_price, 0) + $1,
            updated_at = NOW()
        WHERE id = $2
      `, [totalAmount, orderId]);

      console.log(`âœ… TLL ì—°ë™ ì£¼ë¬¸ì— POS ì£¼ë¬¸ ì¶”ê°€: ì£¼ë¬¸ ${orderId}, ì¶”ê°€ ê¸ˆì•¡ ${totalAmount}ì›`);
    } else {
      // ì¼ë°˜ ì²˜ë¦¬: í•´ë‹¹ í…Œì´ë¸”ì˜ í™œì„± ì£¼ë¬¸ í™•ì¸ ë˜ëŠ” ìƒì„±
      const existingOrderResult = await client.query(`
        SELECT id FROM orders
        WHERE store_id = $1 AND table_num = $2 AND session_status = 'OPEN'
        ORDER BY created_at DESC
        LIMIT 1
      `, [storeId, tableNumber]);

      if (existingOrderResult.rows.length > 0) {
        // ê¸°ì¡´ ì£¼ë¬¸ì— ì¶”ê°€
        orderId = existingOrderResult.rows[0].id;
        console.log(`ğŸ“‹ ê¸°ì¡´ ì£¼ë¬¸ ${orderId}ì— ì¶”ê°€`);

        // ê¸°ì¡´ ì£¼ë¬¸ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
        await client.query(`
          UPDATE orders
          SET total_price = COALESCE(total_price, 0) + $1,
              updated_at = NOW()
          WHERE id = $2
        `, [totalAmount, orderId]);
      } else {
        // ìƒˆ ì£¼ë¬¸ ìƒì„± (ë¹„íšŒì› POS ì£¼ë¬¸: user_id, guest_phone NULL)
        const orderResult = await client.query(`
          INSERT INTO orders (
            store_id,
            table_num,
            user_id,
            guest_phone,
            source,
            status,
            payment_status,
            total_price,
            created_at
          ) VALUES ($1, $2, NULL, NULL, 'POS', 'OPEN', 'PENDING', $3, NOW())
          RETURNING id
        `, [storeId, tableNumber, totalAmount]);

        orderId = orderResult.rows[0].id;
        console.log(`ğŸ“‹ ìƒˆ ë¹„íšŒì› POS ì£¼ë¬¸ ${orderId} ìƒì„± (user_id: NULL, guest_phone: NULL)`);

        // store_tablesì˜ processing_order_id ë˜ëŠ” spare_processing_order_id ì—…ë°ì´íŠ¸
        const currentTableResult = await client.query(`
          SELECT processing_order_id, spare_processing_order_id
          FROM store_tables
          WHERE store_id = $1 AND (id = $2 OR table_number = $2)
        `, [storeId, tableNumber]);

        if (currentTableResult.rows.length > 0) {
          const currentTable = currentTableResult.rows[0];
          const hasMainOrder = currentTable.processing_order_id !== null;
          const hasSpareOrder = currentTable.spare_processing_order_id !== null;

          if (!hasMainOrder) {
            // processing_order_idê°€ ë¹„ì–´ìˆìœ¼ë©´ ë©”ì¸ ì£¼ë¬¸ìœ¼ë¡œ ì„¤ì •
            await client.query(`
              UPDATE store_tables
              SET processing_order_id = $1,
                  status = 'OCCUPIED',
                  updated_at = CURRENT_TIMESTAMP
              WHERE store_id = $2 AND (id = $3 OR table_number = $3)
            `, [orderId, storeId, tableNumber]);
            console.log(`ğŸ“‹ POS ìƒˆ ì£¼ë¬¸ - ë©”ì¸ ì£¼ë¬¸ìœ¼ë¡œ ì„¤ì •: í…Œì´ë¸” ${tableNumber}, ì£¼ë¬¸ ${orderId}`);
          } else if (!hasSpareOrder) {
            // processing_order_idê°€ ì¡´ì¬í•˜ì§€ë§Œ spare_processing_order_idê°€ ë¹„ì–´ìˆìœ¼ë©´ ë³´ì¡° ì£¼ë¬¸ìœ¼ë¡œ ì„¤ì •
            await client.query(`
              UPDATE store_tables
              SET spare_processing_order_id = $1,
                  updated_at = CURRENT_TIMESTAMP
              WHERE store_id = $2 AND (id = $3 OR table_number = $3)
            `, [orderId, storeId, tableNumber]);
            console.log(`ğŸ“‹ POS ìƒˆ ì£¼ë¬¸ - ë³´ì¡° ì£¼ë¬¸ìœ¼ë¡œ ì„¤ì •: í…Œì´ë¸” ${tableNumber}, ê¸°ì¡´ ë©”ì¸ ì£¼ë¬¸ ${currentTable.processing_order_id}, ìƒˆ ë³´ì¡° ì£¼ë¬¸ ${orderId}`);
          } else {
            console.warn(`âš ï¸ POS ìƒˆ ì£¼ë¬¸ - í…Œì´ë¸”ì— ì´ë¯¸ 2ê°œ ì£¼ë¬¸ ì¡´ì¬: í…Œì´ë¸” ${tableNumber}, ë©”ì¸: ${currentTable.processing_order_id}, ë³´ì¡°: ${currentTable.spare_processing_order_id}`);
          }
        } else {
          console.error(`âŒ POS ìƒˆ ì£¼ë¬¸ - í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ë§¤ì¥ ${storeId}, í…Œì´ë¸” ${tableNumber}`);
        }
      }
    }

    // 2. order_tickets í…Œì´ë¸”ì— í‹°ì¼“ ìƒì„±
    const ticketResult = await client.query(`
      INSERT INTO order_tickets (
        order_id,
        store_id,
        batch_no,
        status,
        payment_type,
        source,
        table_num,
        created_at,
        paid_status
      ) VALUES ($1, $2,
        (SELECT COALESCE(MAX(batch_no), 0) + 1 FROM order_tickets WHERE order_id = $1),
        'PENDING', 'POSTPAID', 'POS', $3, NOW(), 'UNPAID')
      RETURNING id, batch_no
    `, [orderId, storeId, tableNumber]);

    const { id: ticketId, batch_no: batchNo } = ticketResult.rows[0];

    // 3. order_items í…Œì´ë¸”ì— ì£¼ë¬¸ ì•„ì´í…œë“¤ ìƒì„±
    for (const item of items) {
      await client.query(`
        INSERT INTO order_items (
          order_id,
          ticket_id,
          menu_name,
          unit_price,
          quantity,
          total_price,
          item_status,
          cook_station,
          created_at,
          menu_id,
          store_id
        ) VALUES ($1, $2, $3, $4, $5, $6, 'PENDING', $7, NOW(), $8, $9)
      `, [
        orderId,
        ticketId,
        item.name,
        item.price,
        item.quantity,
        item.price * item.quantity,
        item.cook_station || 'KITCHEN',
        item.id,
        item.store_id
      ]);
    }

    await client.query('COMMIT');

    console.log(`âœ… POS ì£¼ë¬¸ í™•ì • ì™„ë£Œ: ì£¼ë¬¸ ID ${orderId}, í‹°ì¼“ ID ${ticketId}, ë°°ì¹˜ ${batchNo}`);

    // SSE ë¸Œë¡œë“œìºìŠ¤íŠ¸
    if (global.broadcastPOSTableUpdate) {
      global.broadcastPOSTableUpdate(storeId, tableNumber);
    }

    res.json({
      success: true,
      orderId: orderId,
      ticketId: ticketId,
      batchNo: batchNo,
      isMergedWithTLL: mergeWithExisting && existingOrderId ? true : false,
      message: mergeWithExisting ? 'TLL ì£¼ë¬¸ì— POS ì£¼ë¬¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤'
    });

  } catch (error) {
    await client.query('ROLLBACK');
    console.error('âŒ POS ì£¼ë¬¸ í™•ì • ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ì£¼ë¬¸ í™•ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message
    });
  } finally {
    client.release();
  }
});

/**
 * [POST] /guest-orders/confirm - ë¹„íšŒì› POS ì£¼ë¬¸ í™•ì • ì „ìš© API
 * TLL ì—°ë™ë˜ì§€ ì•Šì€ í…Œì´ë¸”ì—ì„œì˜ ë¹„íšŒì› ì£¼ë¬¸ ì²˜ë¦¬
 */
router.post('/guest-orders/confirm', async (req, res) => {
  const client = await pool.connect();

  try {
    const { storeId, tableNumber, items, totalAmount } = req.body;

    console.log(`ğŸ‘¤ ë¹„íšŒì› POS ì£¼ë¬¸ í™•ì •: ë§¤ì¥ ${storeId}, í…Œì´ë¸” ${tableNumber}, ${items.length}ê°œ ì•„ì´í…œ`);

    if (!storeId || !tableNumber || !items || !Array.isArray(items) || items.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤'
      });
    }

    await client.query('BEGIN');

    // 1. í•´ë‹¹ í…Œì´ë¸”ì˜ ê¸°ì¡´ ë¹„íšŒì› ì£¼ë¬¸ í™•ì¸
    let orderId;

    const existingOrderResult = await client.query(`
      SELECT id FROM orders
      WHERE store_id = $1
        AND table_num = $2
        AND session_status = 'OPEN'
        AND user_id IS NULL
        AND guest_phone IS NULL
        AND source = 'POS'
      ORDER BY created_at DESC
      LIMIT 1
    `, [storeId, tableNumber]);

    if (existingOrderResult.rows.length > 0) {
      // ê¸°ì¡´ ë¹„íšŒì› ì£¼ë¬¸ì— ì¶”ê°€
      orderId = existingOrderResult.rows[0].id;
      console.log(`ğŸ“‹ ê¸°ì¡´ ë¹„íšŒì› ì£¼ë¬¸ ${orderId}ì— ì¶”ê°€`);

      // ê¸°ì¡´ ì£¼ë¬¸ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
      await client.query(`
        UPDATE orders
        SET total_price = COALESCE(total_price, 0) + $1,
            updated_at = NOW()
        WHERE id = $2
      `, [totalAmount, orderId]);
    } else {
      // ìƒˆ ë¹„íšŒì› ì£¼ë¬¸ ìƒì„±
      const orderResult = await client.query(`
        INSERT INTO orders (
          store_id,
          table_num,
          user_id,
          guest_phone,
          source,
          session_status,
          payment_status,
          total_price,
          created_at
        ) VALUES ($1, $2, NULL, NULL, 'POS', 'OPEN', 'PENDING', $3, NOW())
        RETURNING id
      `, [storeId, tableNumber, totalAmount]);

      orderId = orderResult.rows[0].id;
      console.log(`ğŸ“‹ ìƒˆ ë¹„íšŒì› POS ì£¼ë¬¸ ${orderId} ìƒì„±`);

      // store_tablesì˜ processing_order_id ë˜ëŠ” spare_processing_order_id ì—…ë°ì´íŠ¸
      const currentTableResult = await client.query(`
        SELECT processing_order_id, spare_processing_order_id
        FROM store_tables
        WHERE store_id = $1 AND id = $2
      `, [storeId, tableNumber]);

      if (currentTableResult.rows.length > 0) {
        const currentTable = currentTableResult.rows[0];
        const hasMainOrder = currentTable.processing_order_id !== null;
        const hasSpareOrder = currentTable.spare_processing_order_id !== null;

        if (!hasMainOrder) {
          // processing_order_idê°€ ë¹„ì–´ìˆìœ¼ë©´ ë©”ì¸ ì£¼ë¬¸ìœ¼ë¡œ ì„¤ì •
          await client.query(`
            UPDATE store_tables
            SET processing_order_id = $1,
                status = 'OCCUPIED',
                updated_at = CURRENT_TIMESTAMP
            WHERE store_id = $2 AND id = $3
          `, [orderId, storeId, tableNumber]);
          console.log(`ğŸ“‹ ë¹„íšŒì› POS ì£¼ë¬¸ - ë©”ì¸ ì£¼ë¬¸ìœ¼ë¡œ ì„¤ì •: í…Œì´ë¸” ${tableNumber}, ì£¼ë¬¸ ${orderId}`);
        } else if (!hasSpareOrder) {
          // processing_order_idê°€ ì¡´ì¬í•˜ì§€ë§Œ spare_processing_order_idê°€ ë¹„ì–´ìˆìœ¼ë©´ ë³´ì¡° ì£¼ë¬¸ìœ¼ë¡œ ì„¤ì •
          await client.query(`
            UPDATE store_tables
            SET spare_processing_order_id = $1,
                status = 'OCCUPIED',
                updated_at = CURRENT_TIMESTAMP
            WHERE store_id = $2 AND id = $3
          `, [orderId, storeId, tableNumber]);
          console.log(`ğŸ“‹ ë¹„íšŒì› POS ì£¼ë¬¸ - ë³´ì¡° ì£¼ë¬¸ìœ¼ë¡œ ì„¤ì •: í…Œì´ë¸” ${tableNumber}, ê¸°ì¡´ ë©”ì¸ ì£¼ë¬¸ ${currentTable.processing_order_id}, ìƒˆ ë³´ì¡° ì£¼ë¬¸ ${orderId}`);
        } else {
          console.warn(`âš ï¸ ë¹„íšŒì› POS ì£¼ë¬¸ - í…Œì´ë¸”ì— ì´ë¯¸ 2ê°œ ì£¼ë¬¸ ì¡´ì¬: í…Œì´ë¸” ${tableNumber}`);
        }
      } else {
        console.error(`âŒ ë¹„íšŒì› POS ì£¼ë¬¸ - í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ë§¤ì¥ ${storeId}, í…Œì´ë¸” ${tableNumber}`);
      }
    }

    // 2. order_tickets í…Œì´ë¸”ì— í‹°ì¼“ ìƒì„±
    const ticketResult = await client.query(`
      INSERT INTO order_tickets (
        order_id,
        store_id,
        batch_no,
        status,
        payment_type,
        source,
        table_num,
        created_at,
        paid_status
      ) VALUES ($1, $2,
        (SELECT COALESCE(MAX(batch_no), 0) + 1 FROM order_tickets WHERE order_id = $1),
        'PENDING', 'POSTPAID', 'POS', $3, NOW(), 'UNPAID')
      RETURNING id, batch_no
    `, [orderId, storeId, tableNumber]);

    const { id: ticketId, batch_no: batchNo } = ticketResult.rows[0];

    // 3. order_items í…Œì´ë¸”ì— ì£¼ë¬¸ ì•„ì´í…œë“¤ ìƒì„±
    for (const item of items) {
      await client.query(`
        INSERT INTO order_items (
          order_id,
          ticket_id,
          menu_name,
          unit_price,
          quantity,
          total_price,
          item_status,
          cook_station,
          created_at,
          menu_id,
          store_id
        ) VALUES ($1, $2, $3, $4, $5, $6, 'PENDING', $7, NOW(), $8, $9)
      `, [
        orderId,
        ticketId,
        item.name,
        item.price,
        item.quantity,
        item.price * item.quantity,
        item.cook_station || 'KITCHEN',
        item.id,
        storeId
      ]);
    }

    await client.query('COMMIT');

    console.log(`âœ… ë¹„íšŒì› POS ì£¼ë¬¸ í™•ì • ì™„ë£Œ: ì£¼ë¬¸ ID ${orderId}, í‹°ì¼“ ID ${ticketId}, ë°°ì¹˜ ${batchNo}`);

    // SSE ë¸Œë¡œë“œìºìŠ¤íŠ¸
    if (global.broadcastPOSTableUpdate) {
      global.broadcastPOSTableUpdate(storeId, tableNumber);
    }

    res.json({
      success: true,
      orderId: orderId,
      ticketId: ticketId,
      batchNo: batchNo,
      isGuestOrder: true,
      message: 'ë¹„íšŒì› ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤'
    });

  } catch (error) {
    await client.query('ROLLBACK');
    console.error('âŒ ë¹„íšŒì› POS ì£¼ë¬¸ í™•ì • ì‹¤íŒ¨:', error);
    res.status(500).json({
      success: false,
      error: 'ë¹„íšŒì› ì£¼ë¬¸ í™•ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message
    });
  } finally {
    client.release();
  }
});


/**