ğŸ—ºï¸ TLL íšŒì› ì£¼ë¬¸/ê²°ì œ ë¡œì§ (ìµœì¢… ì •ë¦¬)
1ï¸âƒ£ ì£¼ë¬¸ ì‹œì‘ (QR ì§„ì…)

ê³ ê°ì´ í…Œì´ë¸” QR ìŠ¤ìº” â†’ store_id, table_id, user_id í™•ë³´

ë¹„íšŒì› ë¡œì§(guest_phone)ì€ ê±´ë„ˆë›°ê³  íšŒì›(user_id)ë§Œ ì²˜ë¦¬

2ï¸âƒ£ ì¥ë°”êµ¬ë‹ˆ ì‘ì„± (í”„ë¡ íŠ¸ ìƒíƒœ)

ë©”ë‰´/ì˜µì…˜ ì„ íƒ â†’ í´ë¼ì´ì–¸íŠ¸ ì¥ë°”êµ¬ë‹ˆì— ì €ì¥

ê²°ì œ ì „ê¹Œì§€ DB ë°˜ì˜ ì—†ìŒ

renderOrderScreen â†’ renderPay í™”ë©´ ì „í™˜

3ï¸âƒ£ ì£¼ë¬¸ ìƒì„± (ì²« ì£¼ë¬¸ ì‹œ)
(1) orders row ìƒì„±
INSERT INTO orders (
  store_id, table_id, user_id, source,
  status, payment_status, total_price, idempotency_key
) VALUES (
  $store_id, $table_id, $user_id, 'TLL',
  'OPEN', 'UNPAID', 0, $idempotency_key
) RETURNING id;


idempotency_key: ì¤‘ë³µ í´ë¦­ ë°©ì§€ìš© UUID

status=OPEN, payment_status=UNPAID

(2) order_tickets ìƒì„±
INSERT INTO order_tickets (order_id, source, status)
VALUES ($order_id, 'TLL', 'OPEN')
RETURNING id;

(3) order_items bulk insert
INSERT INTO order_items (ticket_id, menu_id, qty, unit_price, options, status)
VALUES
  ($ticket_id, $menu1, $qty1, $price1, $options1::jsonb, 'ORDERED'),
  ($ticket_id, $menu2, $qty2, $price2, $options2::jsonb, 'ORDERED');


ë©”ë‰´ ê°€ê²©ì„ unit_priceë¡œ ìŠ¤ëƒ…ìƒ· ì €ì¥

(4) ì£¼ë¬¸ ê¸ˆì•¡ ê³„ì‚°
SELECT COALESCE(SUM(unit_price * qty), 0)
FROM order_items WHERE ticket_id = $ticket_id;

(5) í• ì¸/ì¿ í° ì ìš© (ìˆì„ ê²½ìš°)
INSERT INTO order_adjustments (order_id, type, amount, reason)
VALUES ($order_id, 'coupon', -2000, 'WELCOME2000');

(6) total_price ì—…ë°ì´íŠ¸
UPDATE orders
SET total_price = GREATEST(0, $calc_total + $sum_adjustments)
WHERE id = $order_id;

4ï¸âƒ£ ê²°ì œ (ì‚¬ì „ ê²°ì œ)
(1) ê²°ì œ intent ìƒì„±
INSERT INTO payments (order_id, amount, method, status, provider, intent_ref)
VALUES ($order_id, $amount, 'CARD', 'PENDING', 'tosspay', $intent_id)
RETURNING id;


í”„ë¡ íŠ¸ì— PG SDK payload ë°˜í™˜

(2) ê²°ì œ ì„±ê³µ ì²˜ë¦¬
UPDATE payments
SET status='SUCCESS', approved_at=NOW(), pg_receipt=$receipt
WHERE id=$payment_id AND status='PENDING';

UPDATE orders
SET payment_status='PAID', status='PAID', updated_at=NOW()
WHERE id=$order_id;


ì‹¤íŒ¨ ì‹œ payments.status='FAIL', orders.status='CANCELED'

5ï¸âƒ£ ì¶”ê°€ ì£¼ë¬¸ (ì¶”ê°€ í‹°ì¼“ ë°©ì‹)
(1) ê¸°ì¡´ orders ì¬ì‚¬ìš©

orders rowëŠ” ê·¸ëŒ€ë¡œ ë‘  (status=OPEN/PAID ìœ ì§€)

(2) ìƒˆë¡œìš´ order_tickets ìƒì„±
INSERT INTO order_tickets (order_id, source, status)
VALUES ($order_id, 'POS', 'OPEN') -- ì¶”ê°€ ì£¼ë¬¸ì´ POSì¼ ìˆ˜ë„ ìˆìŒ
RETURNING id;

(3) order_items insert

ì¶”ê°€ ë©”ë‰´ë“¤ insert

í• ì¸/ì¿ í° ë°œìƒ ì‹œ order_adjustments ì¶”ê°€

(4) ì¶”ê°€ ê²°ì œ ë°œìƒ ì‹œ
INSERT INTO payments (order_id, amount, method, status, provider)
VALUES ($order_id, $add_amount, 'CARD', 'SUCCESS', 'tosspay');


orders.total_priceì— ëˆ„ì  ë°˜ì˜

6ï¸âƒ£ KDS ì—°ë™

ordersê°€ PAIDë¡œ í™•ì •ë˜ë©´

í•´ë‹¹ order_ticketsì™€ order_itemsë¥¼ KDSë¡œ push (Pub/Sub, WebSocket ë“±)

item ìƒíƒœ í”Œë¡œìš°: ORDERED â†’ COOKING â†’ DONE

ticket ìƒíƒœ í”Œë¡œìš°: OPEN â†’ FIRED â†’ DONE

ğŸ” ìƒíƒœ ê´€ë¦¬

orders

status: OPEN â†’ PAID â†’ COMPLETED / CANCELED

payment_status: UNPAID â†’ PAID

order_tickets

source: 'TLL' / 'POS'

status: OPEN â†’ FIRED â†’ DONE

order_items

status: ORDERED â†’ COOKING â†’ DONE

payments

status: PENDING â†’ SUCCESS / FAIL

order_adjustments

ëª¨ë“  í• ì¸/ì¿ í°/ì„œë¹„ìŠ¤ ë¡œê·¸ ê¸°ë¡

ğŸš€ ìš”ì•½

ì²« ì£¼ë¬¸: orders 1ê°œ + order_tickets 1ê°œ + order_items Nê°œ + ê²°ì œ/ì¿ í° ì²˜ë¦¬

ì¶”ê°€ ì£¼ë¬¸: ê¸°ì¡´ orders ì¬ì‚¬ìš©, ticket/itemsë§Œ ìƒˆë¡œ ì¶”ê°€, ê²°ì œ/adjustmentsë„ ë³„ë„ ê¸°ë¡

í˜¼í•© ì£¼ë¬¸ ëŒ€ì‘: ticket.sourceë¡œ POS/TLL êµ¬ë¶„ ê°€ëŠ¥

ê²°ì œ íë¦„: payments ë¡œê·¸ë¡œ ê´€ë¦¬, orders.payment_statusì™€ ë™ê¸°í™”