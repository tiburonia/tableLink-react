const otherActiveOrdersResult = await client.query(`
          SELECT COUNT(*) as count 
          FROM orders o
          JOIN order_tickets ot ON o.id = ot.order_id
          WHERE o.store_id = $1 
            AND o.table_num = $2 
            AND o.session_status = 'OPEN'
            AND o.id != $3
        `, [store_id, table_num, orderId]);

        const hasOtherActiveOrders = parseInt(otherActiveOrdersResult.rows[0].count) > 0;

        if (hasOtherActiveOrders) {
          console.log(`ğŸ”„ POS ê²°ì œ ì™„ë£Œ - ë‹¤ë¥¸ í™œì„± ì£¼ë¬¸ ì¡´ì¬ë¡œ í…Œì´ë¸” ìœ ì§€: ë§¤ì¥ ${store_id}, í…Œì´ë¸” ${table_num}, í˜„ì¬ ì£¼ë¬¸ ${orderId}`);

          // í˜„ì¬ ì£¼ë¬¸ì´ processing_order_idì¸ì§€ spare_processing_order_idì¸ì§€ í™•ì¸í•˜ì—¬ ì²˜ë¦¬
          const currentTableResult = await client.query(`
            SELECT processing_order_id, spare_processing_order_id
            FROM store_tables
            WHERE store_id = $1 AND id = $2
          `, [store_id, table_num]);

          let tableFieldUpdated = false;

          if (currentTableResult.rows.length > 0) {
            const currentTable = currentTableResult.rows[0];
            const processingOrderId = parseInt(currentTable.processing_order_id);
            const spareOrderId = parseInt(currentTable.spare_processing_order_id);
            const currentOrderId = parseInt(orderId);

            if (spareOrderId === currentOrderId) {
              // Case 1: spare_processing_order_idì— í˜„ì¬ ì£¼ë¬¸ì´ ìˆëŠ” ê²½ìš°
              // spareë¥¼ processingìœ¼ë¡œ ì´ë™í•˜ê³  spareëŠ” null ì²˜ë¦¬ (statusëŠ” ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ)
              console.log(`ğŸ” spare_processing_order_id ì²˜ë¦¬ ì „: processing_order_id=${processingOrderId}, spare_processing_order_id=${spareOrderId}, í˜„ì¬ì£¼ë¬¸=${currentOrderId}`);
              
              const updateResult = await client.query(`
                UPDATE store_tables
                SET
                  spare_processing_order_id = NULL,
                  updated_at = CURRENT_TIMESTAMP
                WHERE store_id = $1 AND id = $2 
                RETURNING processing_order_id, spare_processing_order_id
              `, [store_id, table_num]);
              
              if (updateResult.rowCount > 0) {
                const updatedRow = updateResult.rows[0];
                console.log(`âœ… spare_processing_order_id ì²˜ë¦¬ ì™„ë£Œ - ë³´ì¡° ì£¼ë¬¸ì„ ì‚­ì œ (status ìœ ì§€): í…Œì´ë¸” ${table_num}, ì£¼ë¬¸ ${orderId}`);
                console.log(`ğŸ“‹ ì—…ë°ì´íŠ¸ í›„: processing_order_id=${updatedRow.processing_order_id}, spare_processing_order_id=${updatedRow.spare_processing_order_id}`);
                tableFieldUpdated = true;
              } else {
                console.error(`âŒ spare_processing_order_id ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ - ë§¤ì¹­ë˜ëŠ” í…Œì´ë¸” ì—†ìŒ. store_id=${store_id}, table_num=${table_num}`);
              }
            } else if (processingOrderId === currentOrderId) {
              // Case 2: processing_order_idì— í˜„ì¬ ì£¼ë¬¸ì´ ìˆëŠ” ê²½ìš°
              console.log(`ğŸ” processing_order_id ì²˜ë¦¬ ì „: processing_order_id=${processingOrderId}, spare_processing_order_id=${spareOrderId}, í˜„ì¬ì£¼ë¬¸=${currentOrderId}`);
              
              if (currentTable.spare_processing_order_id !== null) {
                // spareê°€ ì¡´ì¬í•˜ë©´ spareë¥¼ processingìœ¼ë¡œ ì´ë™í•˜ê³  spareëŠ” null ì²˜ë¦¬
                const updateResult = await client.query(`
                  UPDATE store_tables
                  SET
                    processing_order_id = spare_processing_order_id,
                    spare_processing_order_id = NULL,
                    updated_at = CURRENT_TIMESTAMP
                  WHERE store_id = $1 AND id = $2
                  RETURNING processing_order_id, spare_processing_order_id
                `, [store_id, table_num]);
                
                if (updateResult.rowCount > 0) {
                  const updatedRow = updateResult.rows[0];
                  console.log(`âœ… processing_order_id ì²˜ë¦¬ ì™„ë£Œ - ë³´ì¡° ì£¼ë¬¸ì„ ë©”ì¸ìœ¼ë¡œ ì´ë™: í…Œì´ë¸” ${table_num}, ì™„ë£Œëœ ì£¼ë¬¸ ${orderId}, ìƒˆ ë©”ì¸ ì£¼ë¬¸ ${updatedRow.processing_order_id}`);
                  console.log(`ğŸ“‹ ì—…ë°ì´íŠ¸ í›„: processing_order_id=${updatedRow.processing_order_id}, spare_processing_order_id=${updatedRow.spare_processing_order_id}`);
                  tableFieldUpdated = true;
                } else {
                  console.error(`âŒ processing_order_id (spare ì´ë™) ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ - ë§¤ì¹­ë˜ëŠ” í…Œì´ë¸” ì—†ìŒ. store_id=${store_id}, table_num=${table_num}`);
                }
              } else {
                // spareê°€ ì—†ìœ¼ë©´ processingì„ null ì²˜ë¦¬í•˜ê³  statusë¥¼ AVAILABLEë¡œ ë³€ê²½
                const updateResult = await client.query(`
                  UPDATE store_tables
                  SET
                    processing_order_id = NULL,
                    spare_processing_order_id = NULL,
                    status = 'AVAILABLE',
                    updated_at = CURRENT_TIMESTAMP
                  WHERE store_id = $1 AND id = $2
                  RETURNING processing_order_id, spare_processing_order_id, status
                `, [store_id, table_num]);
                
                if (updateResult.rowCount > 0) {
                  const updatedRow = updateResult.rows[0];
                  console.log(`âœ… processing_order_id ì²˜ë¦¬ ì™„ë£Œ - í…Œì´ë¸” ì™„ì „ í•´ì œ: í…Œì´ë¸” ${table_num}, ì£¼ë¬¸ ${orderId}`);
                  console.log(`ğŸ“‹ ì—…ë°ì´íŠ¸ í›„: processing_order_id=${updatedRow.processing_order_id}, spare_processing_order_id=${updatedRow.spare_processing_order_id}, status=${updatedRow.status}`);
                  tableFieldUpdated = true;
                } else {
                  console.error(`âŒ processing_order_id (í…Œì´ë¸” í•´ì œ) ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ - ë§¤ì¹­ë˜ëŠ” í…Œì´ë¸” ì—†ìŒ. store_id=${store_id}, table_num=${table_num}`);
                }
              }
            } else {
              console.warn(`âš ï¸ íšŒì›/ë¹„íšŒì› POS ê²°ì œ ì™„ë£Œ - í•´ë‹¹ ì£¼ë¬¸ ${orderId}ì´ í…Œì´ë¸” ${table_num}ì˜ processing_order_id(${processingOrderId}) ë˜ëŠ” spare_processing_order_id(${spareOrderId})ì— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ`);
            }
          } else {
            console.error(`âŒ íšŒì›/ë¹„íšŒì› POS ê²°ì œ ì™„ë£Œ - í…Œì´ë¸” ${table_num}ì„ store_tablesì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
          }

          if (!tableFieldUpdated) {
            console.warn(`âš ï¸ íšŒì›/ë¹„íšŒì› POS ê²°ì œ ì™„ë£Œ - í…Œì´ë¸” ${table_num} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ë˜ëŠ” ì£¼ë¬¸ ${orderId} ë§¤ì¹­ ì‹¤íŒ¨`);
          }
        } else {
          // ë‹¤ë¥¸ í™œì„± ì£¼ë¬¸ì´ ì—†ìœ¼ë©´ í…Œì´ë¸” ì™„ì „ í•´ì œ
          // ë°©ë²• 1: id í•„ë“œë¡œ ë§¤ì¹­
          const tableUpdateResult1 = await client.query(`
            UPDATE store_tables
            SET
              processing_order_id = NULL,
              spare_processing_order_id = NULL,
              status = 'AVAILABLE',
              updated_at = CURRENT_TIMESTAMP
            WHERE store_id = $1 AND id = $2
          `, [store_id, table_num]);

          if (tableUpdateResult1.rowCount > 0) {
            tableUpdated = true;
            console.log(`ğŸ½ï¸ POS ê²°ì œ ì™„ë£Œ í›„ í…Œì´ë¸” ì™„ì „ í•´ì œ (id ë§¤ì¹­): ë§¤ì¥ ${store_id}, í…Œì´ë¸” ${table_num}`);
          } else {
            // ë°©ë²• 2: table_number í•„ë“œë¡œ ë§¤ì¹­
            const tableUpdateResult2 = await client.query(`
              UPDATE store_tables
              SET
                processing_order_id = NULL,
                spare_processing_order_id = NULL,
                status = 'AVAILABLE',
                updated_at = CURRENT_TIMESTAMP
              WHERE store_id = $1 AND id = $2
            `, [store_id, table_num]);

            if (tableUpdateResult2.rowCount > 0) {
              tableUpdated = true;
              console.log(`ğŸ½ï¸ POS ê²°ì œ ì™„ë£Œ í›„ í…Œì´ë¸” ì™„ì „ í•´ì œ (table_number ë§¤ì¹­): ë§¤ì¥ ${store_id}, í…Œì´ë¸” ${table_num}`);
            } else {
              // ë°©ë²• 3: processing_order_idë¡œ ë§¤ì¹­
              const tableUpdateResult3 = await client.query(`
                UPDATE store_tables
                SET
                  processing_order_id = CASE WHEN processing_order_id = $2 THEN spare_processing_order_id ELSE processing_order_id END,
                  spare_processing_order_id = CASE WHEN spare_processing_order_id = $2 THEN NULL ELSE spare_processing_order_id END,
                  status = CASE WHEN processing_order_id = $2 AND spare_processing_order_id IS NULL THEN 'AVAILABLE' ELSE status END,
                  updated_at = CURRENT_TIMESTAMP
                WHERE store_id = $1 AND (processing_order_id = $2 OR spare_processing_order_id = $2)
              `, [store_id, orderId]);

              if (tableUpdateResult3.rowCount > 0) {
                tableUpdated = true;
                console.log(`ğŸ½ï¸ POS ê²°ì œ ì™„ë£Œ í›„ ì£¼ë¬¸ë³„ í•´ì œ ì²˜ë¦¬: ë§¤ì¥ ${store_id}, ì£¼ë¬¸ ${orderId}`);
              }
            }
          }
        }

        if (!tableUpdated) {
          console.warn(`âš ï¸ POS ê²°ì œ ì™„ë£Œ í›„ store_tables ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ë§¤ì¥ ${store_id}, í…Œì´ë¸” ${table_num}, ì£¼ë¬¸ ${orderId}`);
        }
      }

      console.log(`âœ… ì£¼ë¬¸ ${orderId} ì „ì²´ ê²°ì œ ì™„ë£Œ ë° ì„¸ì…˜ ì¢…ë£Œ`);
    }

    await client.query('COMMIT');
