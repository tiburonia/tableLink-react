router.put('/kds/tickets/:ticketId/complete', async (req, res) => {
  const client = await pool.connect();

  try {
    const { ticketId } = req.params;

    console.log(`✅ KDS 티켓 ${ticketId} 완료 처리`);

    await client.query('BEGIN');

    // 현재 시스템에서는 orders 테이블 사용
    // ticketId는 check_id 또는 order id로 사용됨
    
    // 1. 주문 상태를 완료로 변경
    const orderUpdateResult = await client.query(`
      UPDATE order_tickets
      SET status = 'COMPLETED', 
          cooking_status = 'DONE',
          updated_at = CURRENT_TIMESTAMP
      WHERE id = $1
      RETURNING id, store_id, table_num as table_number
    `, [parseInt(ticketId)]);

    if (orderUpdateResult.rows.length === 0) {
      // checks 테이블에서도 확인 시도
      const checkUpdateResult = await client.query(`
        UPDATE checks 
        SET status = 'completed',
            updated_at = CURRENT_TIMESTAMP
        WHERE id = $1
        RETURNING id, store_id, table_num
      `, [parseInt(ticketId)]);

      if (checkUpdateResult.rows.length === 0) {
        await client.query('ROLLBACK');
        return res.status(404).json({
          success: false,
          error: '티켓을 찾을 수 없습니다'
        });
      }

      const check = checkUpdateResult.rows[0];

      // check_items도 완료 상태로 변경
      await client.query(`
        UPDATE check_items 
        SET status = 'served',
            served_at = CURRENT_TIMESTAMP
        WHERE check_id = $1 AND status != 'canceled'
      `, [parseInt(ticketId)]);

      await client.query('COMMIT');

      // WebSocket 브로드캐스트
      if (global.io) {
        global.io.to(`kds:${check.store_id}`).emit('kds-update', {
          type: 'ticket_completed',
          data: {
            ticket_id: parseInt(ticketId),
            check_id: check.id,
            status: 'COMPLETED',
            table_number: check.table_number
          }
        });
      }

      return res.json({
        success: true,
        ticketId: parseInt(ticketId),
        checkId: check.id,
        status: 'COMPLETED',
        message: '주문이 완료되었습니다'
      });
    }

    // orders 테이블 업데이트 성공한 경우
    const order = orderUpdateResult.rows[0];

    await client.query('COMMIT');

    // WebSocket으로 실시간 업데이트 브로드캐스트
    if (global.io) {
      global.io.to(`kds:${order.store_id}`).emit('kds-update', {
        type: 'ticket_completed',
        data: {
          ticket_id: parseInt(ticketId),
          order_id: order.id,
          check_id: order.check_id,
          status: 'COMPLETED',
          table_number: order.table_number
        }
      });
    }

    res.json({
      success: true,
      ticketId: parseInt(ticketId),
      orderId: order.id,
      checkId: order.check_id,
      status: 'COMPLETED',
      message: '주문이 완료되었습니다'
    });

  } catch (error) {
    await client.query('ROLLBACK');
    console.error('❌ KDS 완료 처리 실패:', error);
    res.status(500).json({
      success: false,
      error: '완료 처리 중 오류가 발생했습니다',
      details: error.message
    });
  } finally {
    client.release();
  }
});
