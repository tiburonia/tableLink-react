TossPayments
문제 해결 가이드

목차
문제 분석
근본 원인
해결책
구현 가이드
보안 고려사항
테스트 방법
빠른 링크
TossPayments 문서
GitHub 리포지토리
TossPayments iframe 리다이렉션 문제 해결
Cross-origin 보안 정책으로 인한 결제 완료 후 리다이렉션 실패 문제 해결 가이드

1
2
3
주요 문제 분석
정상 작동 부분
토스페이먼츠 SDK 초기화
결제 요청 및 처리
주문 데이터 준비
문제 발생 부분
결제 완료 후 페이지 이동 실패
Location.href 설정 오류
Cross-origin 보안 정책 차단
발생 에러
Failed to set a named property 'href' on 'Location':
Blocked by cross-origin security policy
근본 원인 분석
1
iframe 보안 제약
토스페이먼츠 결제창이 iframe으로 열리는데, 결제 완료 후 window.location.href로 부모 창을 리다이렉션하려고 할 때 브라우저가 보안상 차단

Same-Origin Policy 위반으로 인한 차단
2
postMessage 방식의 한계
현재 구현된 postMessage 방식도 완전히 작동하지 않음. 메시지 전송은 되지만 리다이렉션 처리에서 문제 발생

Message listener 설정 및 처리 로직 개선 필요
3
서버-클라이언트 처리 충돌
서버에서 리다이렉션을 시도하지만 여전히 iframe 환경에서 실행되어 보안 정책에 의해 차단됨

Server-side redirect가 iframe context에서 실행됨
해결책
Popup 방식
PostMessage 최적화
하이브리드 접근
권장 해결책: Popup Window 방식
iframe 대신 popup window를 사용하여 cross-origin 보안 제약을 우회하고 안전한 리다이렉션을 구현합니다.

구현 방법
// 1. TossPayments 초기화 (Popup 모드)
const tossPayments = TossPayments('test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq');
const payment = tossPayments.payment({
  customerKey: 'customer_unique_key'
});

// 2. 결제 요청 (popup으로 열기)
async function requestPayment() {
  try {
    await payment.requestPayment({
      method: 'CARD',
      amount: {
        currency: 'KRW',
        value: 50000
      },
      orderId: generateOrderId(),
      orderName: '상품명',
      successUrl: 'https://yourdomain.com/success',
      failUrl: 'https://yourdomain.com/fail',
      card: {
        flowMode: 'DEFAULT' // popup으로 열림
      }
    });
  } catch (error) {
    console.error('결제 요청 실패:', error);
  }
}
구현 가이드
1
보안 헤더 설정
먼저 적절한 보안 헤더를 설정하여 TossPayments와의 안전한 통신을 보장합니다.

/* Content Security Policy 설정 */
Content-Security-Policy: 
  frame-src 'self' https://js.tosspayments.com https://pay.toss.im;
  script-src 'self' https://js.tosspayments.com;
  connect-src 'self' https://api.tosspayments.com;

/* X-Frame-Options 설정 */
X-Frame-Options: SAMEORIGIN

/* CORS 설정 */
Access-Control-Allow-Origin: https://js.tosspayments.com
2
클라이언트 사이드 구현
Popup 방식으로 결제를 처리하는 완전한 클라이언트 코드입니다.

// payment.js - 결제 처리 모듈
class TossPaymentHandler {
  constructor(clientKey) {
    this.tossPayments = TossPayments(clientKey);
    this.setupEventListeners();
  }

  setupEventListeners() {
    // PostMessage 리스너 설정 (fallback용)
    window.addEventListener('message', (event) => {
      if (this.isTrustedOrigin(event.origin)) {
        this.handlePaymentMessage(event.data);
      }
    });
  }

  isTrustedOrigin(origin) {
    const trustedOrigins = [
      'https://js.tosspayments.com',
      'https://pay.toss.im'
    ];
    return trustedOrigins.includes(origin);
  }

  async requestPayment(paymentData) {
    try {
      const payment = this.tossPayments.payment({
        customerKey: paymentData.customerKey
      });

      await payment.requestPayment({
        method: 'CARD',
        amount: paymentData.amount,
        orderId: paymentData.orderId,
        orderName: paymentData.orderName,
        successUrl: `${window.location.origin}/payment/success`,
        failUrl: `${window.location.origin}/payment/fail`,
        card: {
          flowMode: 'DEFAULT' // popup으로 열림
        }
      });
    } catch (error) {
      console.error('결제 요청 실패:', error);
      throw error;
    }
  }
}
3
서버 사이드 처리
결제 성공 후 서버에서 안전하게 결제를 확인하고 처리합니다.

// Node.js Express 예제
app.post('/payment/confirm', async (req, res) => {
  const { paymentKey, orderId, amount } = req.body;
  
  try {
    // TossPayments API로 결제 확인
    const response = await fetch('https://api.tosspayments.com/v1/payments/confirm', {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${Buffer.from(secretKey + ':').toString('base64')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ paymentKey, orderId, amount })
    });

    const result = await response.json();
    
    if (response.ok) {
      // 결제 성공 - 데이터베이스 업데이트
      await updateOrderStatus(orderId, 'completed');
      
      res.json({ 
        success: true, 
        redirectUrl: '/order/complete' 
      });
    } else {
      console.error('결제 확인 실패:', result);
      res.status(400).json({ success: false, error: result });
    }
  } catch (error) {
    console.error('서버 오류:', error);
    res.status(500).json({ success: false, error: '서버 오류' });
  }
});
보안 고려사항
HTTPS 강제
모든 결제 관련 요청은 HTTPS 필수
SSL/TLS 인증서 유효성 확인
HTTP → HTTPS 자동 리다이렉션
도메인 검증
신뢰할 수 있는 Origin 확인
PostMessage origin 검증
CSRF 토큰 검증
데이터 무결성
결제 금액 서버 검증
OrderID 중복 확인
PaymentKey 무결성 검증
민감정보 보호
SecretKey 서버 보관
환경변수 암호화
로그 데이터 마스킹
테스트 방법
테스트 시나리오
1. 정상 결제 플로우 테스트
• 결제 요청 → 팝업 열림 → 결제 완료 → 성공 페이지 이동
• 각 단계별 응답 시간 및 에러 여부 확인
2. 에러 상황 테스트
• 네트워크 연결 끊김 시 처리
• 결제 취소 시 적절한 페이지 이동
• 잘못된 카드 정보 입력 시 에러 처리
3. 브라우저 호환성 테스트
• Chrome, Firefox, Safari, Edge 테스트
• 모바일 브라우저 테스트
• 팝업 차단 상황 처리 확인
테스트 코드 예제
// Jest 테스트 예제
describe('TossPayments Integration', () => {
  test('결제 요청이 정상적으로 처리되는지 확인', async () => {
    const paymentData = {
      amount: { currency: 'KRW', value: 10000 },
      orderId: 'test_order_123',
      orderName: '테스트 상품'
    };
    
    const handler = new TossPaymentHandler('test_client_key');
    
    // 결제 요청이 에러 없이 실행되는지 확인
    await expect(handler.requestPayment(paymentData))
      .resolves.not.toThrow();
  });

  test('잘못된 데이터로 결제 요청 시 에러 처리', async () => {
    const invalidData = { amount: -1000 };
    const handler = new TossPaymentHandler('test_client_key');
    
    await expect(handler.requestPayment(invalidData))
      .rejects.toThrow();
  });
});
문제 해결 완료
이 가이드를 따라 구현하면 TossPayments iframe 리다이렉션 문제를 완전히 해결할 수 있습니다. Popup 방식을 우선적으로 사용하되, 환경에 따라 적절한 fallback 메커니즘을 제공하여 모든 상황에서 안정적인 결제 처리가 가능합니다.

Cross-origin 문제 해결
안전한 리다이렉션
향상된 보안
마지막 업데이트: 2025년 1월

TossPayments 공식 문서와 최신 보안 표준을 기반으로 작성되었습니다.

공식 문서
GitHub
지원