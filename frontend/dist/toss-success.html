<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결제 완료 - TableLink</title>
    <link rel="stylesheet" href="/shared/css/toss-success.css">
</head>
<body>
    <div class="container">
        <div class="status-icon">⏳</div>
        <h1>결제 처리 중...</h1>
        <p>잠시만 기다려주세요.</p>
    </div>

    <script src="/TLG/pages/pay/TLL.js"></script>
    <script>
        // TLL 결제 성공 처리 (안전한 버전)
        async function processTLLPaymentSuccess() {
            try {
                const { paymentKey, orderId, amount } = getUrlParams();

                if (!paymentKey || !orderId || !amount) {
                    throw new Error('결제 정보가 올바르지 않습니다.');
                }

                console.log('🔄 TLL 결제 성공 처리 시작:', { paymentKey, orderId, amount });
                showStatus('결제 승인 처리 중...');

                // 토스페이먼츠 결제 승인 직접 호출
                const confirmResponse = await fetch('/api/toss/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentKey, orderId, amount: parseInt(amount) })
                });

                if (!confirmResponse.ok) {
                    const errorData = await confirmResponse.json();
                    throw new Error(errorData.error || '결제 승인 실패');
                }

                const result = await confirmResponse.json();
                console.log('✅ 결제 승인 완료:', result);

                showSuccess({ paymentKey, orderId, amount });

            } catch (error) {
                console.error('❌ TLL 결제 성공 처리 실패:', error);
                showError(`결제 처리 실패: ${error.message}`);
            }
        }

        // TableLink로 돌아가기
        function goBack() {
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.location.href = '/';
                    window.close();
                } else {
                    window.location.href = '/';
                }
            } catch (e) {
                window.location.href = '/';
            }
        }

        // 페이지 로드 시 실행
        console.log('📱 결제 성공 페이지 로드');
        document.addEventListener('DOMContentLoaded', () => {
            processTLLPaymentSuccess();
        });
    </script>
</body>
</html>