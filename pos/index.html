<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TableLink POS ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="/pos/styles/pos.css">
</head>
<body>
    <div id="posMain">
        <div class="pos-loading">
            <div class="loading-spinner"></div>
            <h2>ğŸ´ TableLink POS</h2>
            <p>ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</p>
        </div>
    </div>

    <!-- POS Modules (load first) -->
    <script defer src="/pos/js/modules/orderDataManager.js"></script>
    <script defer src="/pos/js/modules/orderUIRenderer.js"></script>
    <script defer src="/pos/js/modules/orderStateManager.js"></script>
    <script defer src="/pos/js/modules/orderModificationManager.js"></script>
    <script defer src="/pos/js/modules/orderPaymentManager.js"></script>
    <script defer src="/pos/js/modules/orderSessionManager.js"></script>
    <script defer src="/pos/js/modules/orderEventManager.js"></script>
    <script defer src="/pos/js/modules/orderUtilityManager.js"></script>

    <!-- Core POS Scripts (load after modules) -->
    <script defer src="/pos/js/posCore.js"></script>
    <script defer src="/pos/js/tableMapModules/tableMapRenderer.js"></script>
    <script defer src="/pos/js/tableMapModules/crossOrderRenderer.js"></script>
    <script defer src="/pos/js/tableMapModules/tableMapDataProcessor.js"></script>
    <script defer src="/pos/js/tableMapModules/tableMapManager.js"></script>
    <script defer src="/pos/js/posTableMap.js"></script>

    <!-- POS ê²°ì œ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ (ê³ ë„í™” ë²„ì „) -->
        <script defer src="/pos/js/posPaymentModal.js"></script>

        <!-- TLL ì—°ë™ ì „ìš© ê²°ì œ ëª¨ë‹¬ -->
        <script defer src="/pos/js/posTLLPaymentModal.js"></script>
    <script defer src="/pos/js/posOrderScreen.js"></script>

    <script>
        // ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì™„ë£Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        let loadedModules = new Set();
        const requiredModules = ['POSCore', 'POSOrderScreen', 'POSPaymentModal', 'POSTableMap', 'TableMapRenderer', 'CrossOrderRenderer', 'TableMapDataProcessor', 'TableMapManager'];

        // ëª¨ë“ˆ ë¡œë”© ì²´í¬ í•¨ìˆ˜
        function checkModuleLoading(moduleName) {
            if (typeof window[moduleName] !== 'undefined') {
                loadedModules.add(moduleName);
                console.log(`âœ… ${moduleName} ë¡œë“œ ì™„ë£Œ`);

                // ëª¨ë“  ëª¨ë“ˆì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (loadedModules.size === requiredModules.length) {
                    console.log('âœ… ëª¨ë“  í•„ìˆ˜ ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ');
                    initializePOSSystem();
                }
            }
        }

        // ê° ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í›„ ì²´í¬
        function validateModuleLoading() {
            requiredModules.forEach(moduleName => {
                checkModuleLoading(moduleName);
            });
        }

        // POS ì‹œìŠ¤í…œ ì´ˆê¸°í™” í•¨ìˆ˜
        async function initializePOSSystem() {
            console.log('ğŸš€ POS ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');

            // ì¶”ê°€ ê²€ì¦: POSPaymentModalì˜ ë©”ì„œë“œë“¤ì´ ì˜¬ë°”ë¥´ê²Œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            const paymentModalValidation = {
                exists: typeof window.POSPaymentModal !== 'undefined',
                hasShow: typeof window.POSPaymentModal?.show === 'function',
                hasHide: typeof window.POSPaymentModal?.hide === 'function',
                hasRender: typeof window.POSPaymentModal?.render === 'function'
            };

            console.log('ğŸ” POSPaymentModal ê²€ì¦ ê²°ê³¼:', paymentModalValidation);

            if (!paymentModalValidation.exists || !paymentModalValidation.hasShow) {
                console.error('âŒ POSPaymentModalì´ ì˜¬ë°”ë¥´ê²Œ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');

                // ê°•ì œ ì¬ë¡œë”© ì‹œë„
                try {
                    console.log('ğŸ”„ POSPaymentModal ê°•ì œ ì¬ë¡œë”© ì‹œë„');
                    const script = document.createElement('script');
                    script.src = '/pos/js/posPaymentModal.js';
                    script.onload = () => {
                        console.log('âœ… POSPaymentModal ì¬ë¡œë”© ì™„ë£Œ');
                        proceedWithInitialization();
                    };
                    script.onerror = () => {
                        console.error('âŒ POSPaymentModal ì¬ë¡œë”© ì‹¤íŒ¨');
                        proceedWithInitialization();
                    };
                    document.head.appendChild(script);
                    return;
                } catch (error) {
                    console.error('âŒ POSPaymentModal ì¬ë¡œë”© ì¤‘ ì˜¤ë¥˜:', error);
                }
            }

            proceedWithInitialization();
        }

        // ì‹¤ì œ ì´ˆê¸°í™” ì§„í–‰
        function proceedWithInitialization() {
            // URLì—ì„œ ë§¤ì¥ ID íŒŒì‹±
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('storeId');

            if (!storeId) {
                alert('ë§¤ì¥ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                window.history.back();
                return;
            }

            // POSCoreê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ ìµœì¢… í™•ì¸
            if (typeof POSCore !== 'undefined' && typeof POSCore.initialize === 'function') {
                console.log('ğŸš€ POS ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì§„í–‰');
                POSCore.initialize(parseInt(storeId));
            } else {
                console.error('âŒ POSCoreê°€ ë¡œë“œë˜ì§€ ì•Šì•„ ì´ˆê¸°í™” ë¶ˆê°€');
                alert('POS ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        }

        // DOM ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ”„ DOM ë¡œë“œ ì™„ë£Œ, POS ëª¨ë“ˆ ê²€ì¦ ì‹œì‘');

            // ì´ˆê¸° ëª¨ë“ˆ ê²€ì¦
            validateModuleLoading();

            // ì¼ì • ì‹œê°„ í›„ì—ë„ ëª¨ë“  ëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê°•ì œ ì§„í–‰
            setTimeout(() => {
                if (loadedModules.size < requiredModules.length) {
                    console.warn('âš ï¸ ì¼ë¶€ ëª¨ë“ˆ ë¡œë”©ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ê°•ì œ ì§„í–‰í•©ë‹ˆë‹¤.');
                    console.log('í˜„ì¬ ë¡œë“œëœ ëª¨ë“ˆ:', Array.from(loadedModules));
                    console.log('ëˆ„ë½ëœ ëª¨ë“ˆ:', requiredModules.filter(m => !loadedModules.has(m)));

                    // ëˆ„ë½ëœ ëª¨ë“ˆì´ POSPaymentModalë¿ì´ë¼ë©´ ê²½ê³ ì™€ í•¨ê»˜ ì§„í–‰
                    const missingModules = requiredModules.filter(m => !loadedModules.has(m));
                    if (missingModules.length === 1 && missingModules[0] === 'POSPaymentModal') {
                        console.warn('âš ï¸ POSPaymentModalë§Œ ëˆ„ë½ë¨. ê²°ì œ ê¸°ëŠ¥ ì œí•œê³¼ í•¨ê»˜ ì§„í–‰í•©ë‹ˆë‹¤.');
                        alert('ê²°ì œ ëª¨ë‹¬ ê¸°ëŠ¥ì— ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    }

                    proceedWithInitialization();
                }
            }, 5000); // 5ì´ˆ íƒ€ì„ì•„ì›ƒ
        });

        // POSPaymentModal ë¡œë“œ ì—ëŸ¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('POSPaymentModalLoadError', (event) => {
            console.error('âŒ POSPaymentModal ë¡œë“œ ì—ëŸ¬ ì´ë²¤íŠ¸ ìˆ˜ì‹ :', event.detail);
            alert('ê²°ì œ ëª¨ë‹¬ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê²°ì œ ê¸°ëŠ¥ì— ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ SSE ì—°ê²° ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (window.POSTableMap && typeof window.POSTableMap.closeSSE === 'function') {
                window.POSTableMap.closeSSE();
            }
        });
    </script>
</body>
</html>